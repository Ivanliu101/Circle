<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CircleOS v0.0.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.544.0/dist/umd/lucide.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8B5CF6',
                        secondary: '#EC4899',
                        accent: '#06B6D4',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .glass {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            .glass-hover {
                background: rgba(255, 255, 255, 0.15);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.3);
            }
            .window-shadow {
                box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            }
            .sidebar-icon {
                @apply relative flex items-center justify-center h-12 w-12 mt-2 mb-2 mx-auto shadow-lg
                bg-gray-800 text-primary hover:bg-primary hover:text-white
                rounded-3xl hover:rounded-xl transition-all duration-300 ease-linear
                cursor-pointer;
            }
            .sidebar-tooltip {
                @apply absolute w-auto p-2 m-2 min-w-max left-14 rounded-md shadow-md
                text-white bg-gray-900
                text-xs font-bold transition-all duration-100 scale-0 origin-left;
            }
            .sidebar-hr {
                @apply bg-gray-700 border border-gray-700 rounded-full mx-2;
            }
            .window-header {
                @apply flex items-center justify-between p-2 bg-gray-800 text-white rounded-t-lg cursor-move;
            }
            .window-content {
                @apply p-4 bg-white rounded-b-lg h-full overflow-auto;
            }
            .window-button {
                @apply w-8 h-8 flex items-center justify-center rounded-full mx-1 transition-all duration-200;
            }
            .active-window {
                @apply border-l-4 border-blue-500;
            }
            .minimized-window {
                @apply border-l-4 border-gray-500;
            }
        }
    </style>
    <link rel="stylesheet" href="animations.css">
</head>
<body class="bg-gradient-to-br from-pink-300 via-purple-300 to-indigo-400 min-h-screen font-sans text-gray-900 overflow-hidden">

<!-- Background Animation -->
<div id="bg-animation" class="fixed inset-0 z-0 opacity-20"></div>

<!-- Main Container -->
<div class="relative z-10 flex h-screen">

    <!-- Left Sidebar -->
    <div class="sidebar glass w-16 flex flex-col items-center py-4">
        <!-- Search -->
        <div class="sidebar-icon group mb-4" id="search-button">
            <i data-lucide="search" class="w-6 h-6"></i>
            <span class="sidebar-tooltip group-hover:scale-100">Search</span>
        </div>

        <!-- Apps -->
        <div class="sidebar-icon group" data-app="vs-code">
            <span class="text-xl">üíª</span>
            <span class="sidebar-tooltip group-hover:scale-100">VS Code</span>
        </div>
        <div class="sidebar-icon group" data-app="notepad">
            <span class="text-xl">üìù</span>
            <span class="sidebar-tooltip group-hover:scale-100">Notepad</span>
        </div>
        <div class="sidebar-icon group" data-app="calendar">
            <span class="text-xl">üìÖ</span>
            <span class="sidebar-tooltip group-hover:scale-100">Calendar</span>
        </div>
        <div class="sidebar-icon group" data-app="files">
            <span class="text-xl">üìÅ</span>
            <span class="sidebar-tooltip group-hover:scale-100">Files</span>
        </div>
        <div class="sidebar-icon group" data-app="browser">
            <span class="text-xl">üåê</span>
            <span class="sidebar-tooltip group-hover:scale-100">Browser</span>
        </div>
        <div class="sidebar-icon group" data-app="paint">
            <span class="text-xl">üé®</span>
            <span class="sidebar-tooltip group-hover:scale-100">Paint</span>
        </div>
        <div class="sidebar-icon group" data-app="settings">
            <span class="text-xl">‚öôÔ∏è</span>
            <span class="sidebar-tooltip group-hover:scale-100">Settings</span>
        </div>

        <hr class="sidebar-hr my-4">

        <!-- System Info -->
        <div class="sidebar-icon group mt-auto" id="system-info">
            <i data-lucide="info" class="w-6 h-6"></i>
            <span class="sidebar-tooltip group-hover:scale-100">System Info</span>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="search-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="glass p-8 rounded-2xl w-1/3 animate-fade-in">
            <div class="relative">
                <input type="text" id="search-input" placeholder="Search apps..." class="w-full p-4 pl-12 rounded-lg bg-white bg-opacity-20 border border-white border-opacity-30 text-white placeholder-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-6 h-6 text-white"></i>
            </div>
            <div id="search-results" class="mt-4 max-h-60 overflow-y-auto">
                <!-- Search results will be populated here -->
            </div>
        </div>
    </div>

    <!-- Windows Container -->
    <div id="windows-container" class="flex-1 relative overflow-hidden">
        <!-- Windows will be dynamically created here -->
    </div>

    <!-- Lock Screen -->
    <div id="lock-screen" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center">
        <div class="glass p-8 rounded-2xl w-96 animate-fade-in">
            <h1 class="text-2xl font-bold text-center text-white mb-8">CircleOS Locked</h1>
            <div class="mb-6">
                <label for="pin-input" class="block text-sm font-medium text-white mb-2">Enter PIN to unlock</label>
                <input type="password" id="pin-input" maxlength="4" class="w-full p-3 rounded-lg bg-white bg-opacity-20 border border-white border-opacity-30 text-white text-center text-2xl focus:outline-none focus:ring-2 focus:ring-primary" placeholder="****">
            </div>
            <button id="unlock-button" class="w-full py-3 bg-primary hover:bg-primary/80 text-white font-semibold rounded-lg transition-colors duration-200">Unlock</button>
        </div>
    </div>
</div>

<script>
    // Initialize Lucide icons
    lucide.createIcons();

    // App definitions
    const apps = {
        'vs-code': {
            name: 'VS Code',
            icon: 'üíª',
            width: 800,
            height: 600,
            content: `
                    <div class="flex h-full bg-gray-900 text-white">
                        <div class="w-48 bg-gray-800 p-4">
                            <div class="text-sm text-gray-400 mb-2">FILES</div>
                            <div class="space-y-1">
                                <div class="flex items-center text-sm hover:text-primary cursor-pointer"><i data-lucide="file-code" class="w-4 h-4 mr-2"></i>main.js</div>
                                <div class="flex items-center text-sm hover:text-primary cursor-pointer"><i data-lucide="file-code" class="w-4 h-4 mr-2"></i>style.css</div>
                                <div class="flex items-center text-sm hover:text-primary cursor-pointer"><i data-lucide="file-code" class="w-4 h-4 mr-2"></i>index.html</div>
                            </div>
                        </div>
                        <div class="flex-1 flex flex-col">
                            <div class="bg-gray-800 p-2 flex items-center space-x-2 border-b border-gray-700">
                                <span class="text-sm">main.js - Visual Studio Code</span>
                            </div>
                            <div class="flex-1 p-4 font-mono text-sm overflow-auto">
                                <pre class="text-green-400">// Welcome to CircleOS VS Code</pre>
                                <pre class="text-blue-400">function <span class="text-yellow-300">greet</span>() {</pre>
                                <pre class="text-white">  <span class="text-purple-400">console</span>.<span class="text-yellow-300">log</span>(<span class="text-green-300">"Hello, CircleOS!"</span>);</pre>
                                <pre class="text-blue-400">}</pre>
                                <pre class="text-white"><span class="text-yellow-300">greet</span>();</pre>
                            </div>
                        </div>
                    </div>
                `
        },
        'notepad': {
            name: 'Notepad',
            icon: 'üìù',
            width: 600,
            height: 400,
            content: `
                    <textarea class="w-full h-full p-4 bg-white border-0 focus:ring-0 resize-none" placeholder="Start typing..."></textarea>
                `
        },
        'calendar': {
            name: 'Calendar',
            icon: 'üìÖ',
            width: 700,
            height: 500,
            content: `
                    <div class="h-full">
                        <div class="flex justify-between items-center mb-4">
                            <button class="text-primary hover:text-primary/80"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                            <h2 class="text-xl font-bold">June 2024</h2>
                            <button class="text-primary hover:text-primary/80"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                        </div>
                        <div class="grid grid-cols-7 gap-1 text-center mb-2">
                            <div class="text-sm font-semibold text-gray-600">Sun</div>
                            <div class="text-sm font-semibold text-gray-600">Mon</div>
                            <div class="text-sm font-semibold text-gray-600">Tue</div>
                            <div class="text-sm font-semibold text-gray-600">Wed</div>
                            <div class="text-sm font-semibold text-gray-600">Thu</div>
                            <div class="text-sm font-semibold text-gray-600">Fri</div>
                            <div class="text-sm font-semibold text-gray-600">Sat</div>
                        </div>
                        <div class="grid grid-cols-7 gap-1">
                            ${Array(30).fill(0).map((_, i) => `
                                <div class="h-12 flex items-center justify-center rounded-lg hover:bg-gray-100 cursor-pointer ${i === 14 ? 'bg-primary text-white' : ''}">
                                    ${i + 1}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `
        },
        'files': {
            name: 'Files',
            icon: 'üìÅ',
            width: 750,
            height: 550,
            content: `
                    <div class="h-full flex flex-col">
                        <div class="bg-gray-100 p-4 rounded-t-lg border-b">
                            <div class="flex items-center space-x-2">
                                <button class="px-3 py-1 bg-white border rounded hover:bg-gray-50 text-sm">üìÅ Documents</button>
                                <button class="px-3 py-1 bg-white border rounded hover:bg-gray-50 text-sm">üì∑ Pictures</button>
                                <button class="px-3 py-1 bg-white border rounded hover:bg-gray-50 text-sm">üéµ Music</button>
                            </div>
                        </div>
                        <div class="flex-1 p-4 overflow-auto">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="flex items-center p-3 bg-white rounded-lg hover:bg-gray-50 cursor-pointer border">
                                    <span class="text-2xl mr-3">üìÅ</span>
                                    <div>
                                        <div class="font-medium">Projects</div>
                                        <div class="text-xs text-gray-500">Folder</div>
                                    </div>
                                </div>
                                <div class="flex items-center p-3 bg-white rounded-lg hover:bg-gray-50 cursor-pointer border">
                                    <span class="text-2xl mr-3">üìÑ</span>
                                    <div>
                                        <div class="font-medium">Resume.pdf</div>
                                        <div class="text-xs text-gray-500">PDF - 2MB</div>
                                    </div>
                                </div>
                                <div class="flex items-center p-3 bg-white rounded-lg hover:bg-gray-50 cursor-pointer border">
                                    <span class="text-2xl mr-3">üì∑</span>
                                    <div>
                                        <div class="font-medium">Screenshot.png</div>
                                        <div class="text-xs text-gray-500">Image - 1MB</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `
        },
        'browser': {
            name: 'Browser',
            icon: 'üåê',
            width: 900,
            height: 600,
            content: `
                    <div class="h-full flex flex-col">
                        <div class="bg-gray-100 p-2 flex items-center space-x-2 border-b">
                            <div class="flex-1 flex items-center bg-white rounded px-3 py-1 border">
                                <i data-lucide="search" class="w-4 h-4 text-gray-400 mr-2"></i>
                                <input type="text" class="w-full border-0 focus:ring-0 text-sm" value="https://circleos.com/home" readonly>
                            </div>
                            <button class="p-1 hover:bg-gray-200 rounded"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                            <button class="p-1 hover:bg-gray-200 rounded"><i data-lucide="home" class="w-4 h-4"></i></button>
                        </div>
                        <div class="flex-1 overflow-auto p-4">
                            <div class="max-w-4xl mx-auto">
                                <h1 class="text-3xl font-bold mb-4 text-center text-primary">Welcome to CircleOS Browser</h1>
                                <p class="text-center text-gray-600 mb-8">Your gateway to the internet</p>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div class="bg-white p-6 rounded-lg shadow-md text-center hover:shadow-lg transition-shadow">
                                        <div class="text-4xl mb-4">üìß</div>
                                        <h3 class="font-semibold mb-2">Email</h3>
                                        <p class="text-sm text-gray-500">Check your messages</p>
                                    </div>
                                    <div class="bg-white p-6 rounded-lg shadow-md text-center hover:shadow-lg transition-shadow">
                                        <div class="text-4xl mb-4">üì∫</div>
                                        <h3 class="font-semibold mb-2">Videos</h3>
                                        <p class="text-sm text-gray-500">Watch videos online</p>
                                    </div>
                                    <div class="bg-white p-6 rounded-lg shadow-md text-center hover:shadow-lg transition-shadow">
                                        <div class="text-4xl mb-4">üéÆ</div>
                                        <h3 class="font-semibold mb-2">Games</h3>
                                        <p class="text-sm text-gray-500">Play games online</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `
        },
        'paint': {
            name: 'Paint',
            icon: 'üé®',
            width: 800,
            height: 600,
            content: `
                    <div class="h-full flex">
                        <div class="w-20 bg-gray-100 border-r p-2 flex flex-col space-y-2">
                            <button class="w-12 h-12 bg-white border rounded hover:bg-gray-50 flex items-center justify-center" data-tool="brush"><i data-lucide="brush" class="w-6 h-6"></i></button>
                            <button class="w-12 h-12 bg-white border rounded hover:bg-gray-50 flex items-center justify-center" data-tool="eraser"><i data-lucide="eraser" class="w-6 h-6"></i></button>
                            <button class="w-12 h-12 bg-white border rounded hover:bg-gray-50 flex items-center justify-center" data-tool="square"><i data-lucide="square" class="w-6 h-6"></i></button>
                            <button class="w-12 h-12 bg-white border rounded hover:bg-gray-50 flex items-center justify-center" data-tool="circle"><i data-lucide="circle" class="w-6 h-6"></i></button>
                            <div class="border-t pt-2 mt-2">
                                <div class="text-xs text-center mb-2">Colors</div>
                                <div class="grid grid-cols-2 gap-1">
                                    ${['#000000', '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#FFFFFF'].map(color => `
                                        <button class="w-6 h-6 rounded-full border" style="background-color: ${color}" data-color="${color}"></button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="flex-1">
                            <canvas id="paint-canvas" class="w-full h-full bg-white cursor-crosshair"></canvas>
                        </div>
                    </div>
                `
        },
        'settings': {
            name: 'Settings',
            icon: '‚öôÔ∏è',
            width: 600,
            height: 500,
            content: `
                    <div class="h-full">
                        <div class="flex mb-6">
                            <button class="px-4 py-2 bg-primary text-white rounded-l-lg">General</button>
                            <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-r-lg">Security</button>
                        </div>
                        <div class="space-y-6">
                            <div class="bg-white p-4 rounded-lg border">
                                <h3 class="font-semibold mb-3">System</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span>System Version</span>
                                        <span class="text-gray-600">v0.0.1</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span>Auto-lock</span>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" class="sr-only peer" checked>
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-lg border">
                                <h3 class="font-semibold mb-3">Personalization</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm mb-1">Theme</label>
                                        <select class="w-full p-2 border rounded bg-white">
                                            <option>Pink & Purple</option>
                                            <option>Blue & Green</option>
                                            <option>Dark Mode</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-lg border">
                                <h3 class="font-semibold mb-3">Security</h3>
                                <div class="space-y-3">
                                    <button id="change-pin-button" class="w-full py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm">Change PIN</button>
                                    <button id="lock-now-button" class="w-full py-2 bg-primary text-white rounded-lg text-sm">Lock Now</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `
        }
    };

    // Global variables
    let activeWindows = {};
    let nextWindowId = 1;
    let isDragging = false;
    let dragOffset = { x: 0, y: 0 };
    let activeWindowElement = null;
    let currentColor = '#000000';
    let currentTool = 'brush';
    let isPainting = false;

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
        initializeBackground();
        initializeEventListeners();
        initializePaintApp();
        loadSystemState();
    });

    // Initialize background animation
    function initializeBackground() {
        const canvas = document.createElement('canvas');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        document.getElementById('bg-animation').appendChild(canvas);

        const ctx = canvas.getContext('2d');
        const particles = [];
        const particleCount = 50;

        for (let i = 0; i < particleCount; i++) {
            particles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                size: Math.random() * 3 + 1,
                speedX: Math.random() * 0.5 - 0.25,
                speedY: Math.random() * 0.5 - 0.25,
                color: `rgba(${Math.random() * 255}, ${Math.random() * 100 + 155}, ${Math.random() * 255}, 0.5)`
            });
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(particle => {
                ctx.fillStyle = particle.color;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                ctx.fill();

                particle.x += particle.speedX;
                particle.y += particle.speedY;

                if (particle.x < 0 || particle.x > canvas.width) particle.speedX *= -1;
                if (particle.y < 0 || particle.y > canvas.height) particle.speedY *= -1;
            });
            requestAnimationFrame(animate);
        }
        animate();
    }

    // Initialize event listeners
    function initializeEventListeners() {
        // App launchers
        document.querySelectorAll('[data-app]').forEach(launcher => {
            launcher.addEventListener('click', () => {
                const appName = launcher.getAttribute('data-app');
                openWindow(appName);
            });
        });

        // Search functionality
        document.getElementById('search-button').addEventListener('click', () => {
            document.getElementById('search-modal').classList.toggle('hidden');
            document.getElementById('search-input').focus();
        });

        document.getElementById('search-input').addEventListener('input', handleSearch);

        // Close search modal when clicking outside
        document.getElementById('search-modal').addEventListener('click', (e) => {
            if (e.target.id === 'search-modal') {
                document.getElementById('search-modal').classList.add('hidden');
            }
        });

        // System info
        document.getElementById('system-info').addEventListener('click', showSystemInfo);

        // Lock screen functionality
        document.getElementById('unlock-button').addEventListener('click', unlockSystem);
        document.getElementById('pin-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                unlockSystem();
            }
        });

        // Settings buttons
        document.addEventListener('click', (e) => {
            if (e.target.id === 'lock-now-button') {
                lockSystem();
            }
            if (e.target.id === 'change-pin-button') {
                changePin();
            }
        });

        // Click outside to focus window
        document.getElementById('windows-container').addEventListener('click', (e) => {
            if (e.target.id === 'windows-container') {
                focusWindow(null);
            }
        });
    }

    // Handle search
    function handleSearch(e) {
        const query = e.target.value.toLowerCase();
        const results = document.getElementById('search-results');

        if (query.length === 0) {
            results.innerHTML = '';
            return;
        }

        const filteredApps = Object.entries(apps).filter(([key, app]) =>
            app.name.toLowerCase().includes(query)
        );

        results.innerHTML = filteredApps.map(([key, app]) => `
                <div class="flex items-center p-2 hover:bg-white hover:bg-opacity-10 rounded cursor-pointer animate-fade-in" onclick="openWindow('${key}'); document.getElementById('search-modal').classList.add('hidden')">
                    <span class="text-xl mr-3">${app.icon}</span>
                    <span>${app.name}</span>
                </div>
            `).join('');
    }

    // Open a new window
    function openWindow(appName) {
        const app = apps[appName];
        if (!app) return;

        const windowId = `window-${nextWindowId++}`;
        const windowElement = document.createElement('div');
        windowElement.id = windowId;
        windowElement.className = 'fixed glass window-shadow rounded-lg overflow-hidden animate-slide-in-center z-20 transition-all duration-200';
        windowElement.style.width = `${app.width}px`;
        windowElement.style.height = `${app.height}px`;
        windowElement.style.left = `calc(50% - ${app.width / 2}px)`;
        windowElement.style.top = `calc(50% - ${app.height / 2}px)`;

        windowElement.innerHTML = `
                <div class="window-header" data-window-id="${windowId}">
                    <div class="flex items-center">
                        <span class="text-xl mr-2">${app.icon}</span>
                        <span>${app.name}</span>
                    </div>
                    <div class="flex">
                        <button class="window-button hover:bg-gray-700" onclick="minimizeWindow('${windowId}')">
                            <i data-lucide="minus" class="w-4 h-4"></i>
                        </button>
                        <button class="window-button hover:bg-gray-700" onclick="maximizeWindow('${windowId}')">
                            <i data-lucide="maximize" class="w-4 h-4"></i>
                        </button>
                        <button class="window-button hover:bg-red-500" onclick="closeWindow('${windowId}')">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                <div class="window-content">
                    ${app.content}
                </div>
            `;

        document.getElementById('windows-container').appendChild(windowElement);
        lucide.createIcons();

        // Add to active windows
        activeWindows[windowId] = {
            app: appName,
            element: windowElement,
            isMinimized: false,
            originalSize: { width: app.width, height: app.height },
            originalPosition: { left: windowElement.style.left, top: windowElement.style.top }
        };

        // Update sidebar indicator
        updateSidebarIndicators();

        // Focus this window
        focusWindow(windowId);

        // Initialize window dragging
        initializeWindowDragging(windowElement);

        // Initialize app-specific functionality
        if (appName === 'paint') {
            initializePaintCanvas(windowId);
        }
    }

    // Initialize window dragging
    function initializeWindowDragging(windowElement) {
        const header = windowElement.querySelector('.window-header');

        header.addEventListener('mousedown', (e) => {
            if (e.target.closest('.window-button')) return;

            isDragging = true;
            const rect = windowElement.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;

            activeWindowElement = windowElement;
            focusWindow(windowElement.id);

            e.preventDefault();
        });
    }

    // Handle mouse movement for dragging
    document.addEventListener('mousemove', (e) => {
        if (!isDragging || !activeWindowElement) return;

        const container = document.getElementById('windows-container');
        const containerRect = container.getBoundingClientRect();

        let newX = e.clientX - dragOffset.x - containerRect.left;
        let newY = e.clientY - dragOffset.y - containerRect.top;

        // Constrain to container
        newX = Math.max(0, Math.min(newX, containerRect.width - activeWindowElement.offsetWidth));
        newY = Math.max(0, Math.min(newY, containerRect.height - activeWindowElement.offsetHeight));

        activeWindowElement.style.left = `${newX}px`;
        activeWindowElement.style.top = `${newY}px`;
    });

    // Handle mouse up to stop dragging
    document.addEventListener('mouseup', () => {
        isDragging = false;
        activeWindowElement = null;
    });

    // Focus a window
    function focusWindow(windowId) {
        // Remove focus from all windows
        Object.values(activeWindows).forEach(window => {
            window.element.classList.remove('z-30');
            window.element.classList.add('z-20');
        });

        // Focus the selected window
        if (windowId && activeWindows[windowId]) {
            activeWindows[windowId].element.classList.remove('z-20');
            activeWindows[windowId].element.classList.add('z-30');
        }
    }

    // Minimize a window
    function minimizeWindow(windowId) {
        const window = activeWindows[windowId];
        if (!window) return;

        if (window.isMinimized) {
            // Restore window
            window.element.style.display = 'block';
            window.element.style.width = `${window.originalSize.width}px`;
            window.element.style.height = `${window.originalSize.height}px`;
            window.element.style.left = window.originalPosition.left;
            window.element.style.top = window.originalPosition.top;
            window.isMinimized = false;
        } else {
            // Minimize window
            window.originalPosition = {
                left: window.element.style.left,
                top: window.element.style.top
            };
            window.element.style.display = 'none';
            window.isMinimized = true;
        }

        updateSidebarIndicators();
    }

    // Maximize a window
    function maximizeWindow(windowId) {
        const window = activeWindows[windowId];
        if (!window) return;

        const container = document.getElementById('windows-container');
        const containerRect = container.getBoundingClientRect();

        if (window.element.style.width === '100%') {
            // Restore original size
            window.element.style.width = `${window.originalSize.width}px`;
            window.element.style.height = `${window.originalSize.height}px`;
            window.element.style.left = window.originalPosition.left;
            window.element.style.top = window.originalPosition.top;
        } else {
            // Maximize
            window.originalPosition = {
                left: window.element.style.left,
                top: window.element.style.top
            };
            window.element.style.width = '100%';
            window.element.style.height = '100%';
            window.element.style.left = '0';
            window.element.style.top = '0';
        }
    }

    // Close a window
    function closeWindow(windowId) {
        const window = activeWindows[windowId];
        if (!window) return;

        window.element.classList.add('animate-slide-out-center');
        setTimeout(() => {
            window.element.remove();
            delete activeWindows[windowId];
            updateSidebarIndicators();
        }, 200);
    }

    // Update sidebar indicators
    function updateSidebarIndicators() {
        // Clear all indicators
        document.querySelectorAll('.sidebar-icon').forEach(icon => {
            icon.classList.remove('active-window', 'minimized-window');
        });

        // Add indicators for open windows
        const appWindows = {};
        Object.values(activeWindows).forEach(window => {
            if (!appWindows[window.app] || !window.isMinimized) {
                appWindows[window.app] = window.isMinimized;
            }
        });

        // Update icons
        Object.entries(appWindows).forEach(([appName, isMinimized]) => {
            const icon = document.querySelector(`[data-app="${appName}"]`);
            if (icon) {
                icon.classList.add(isMinimized ? 'minimized-window' : 'active-window');
            }
        });
    }

    // Initialize paint app
    function initializePaintApp() {
        document.addEventListener('click', (e) => {
            if (e.target.closest('[data-tool]')) {
                currentTool = e.target.closest('[data-tool]').dataset.tool;
                document.querySelectorAll('[data-tool]').forEach(btn => btn.classList.remove('bg-primary', 'text-white'));
                e.target.closest('[data-tool]').classList.add('bg-primary', 'text-white');
            }

            if (e.target.closest('[data-color]')) {
                currentColor = e.target.closest('[data-color]').dataset.color;
            }
        });
    }

    // Initialize paint canvas for a specific window
    function initializePaintCanvas(windowId) {
        const windowElement = document.getElementById(windowId);
        const canvas = windowElement.querySelector('#paint-canvas');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');

        // Set canvas size
        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
        }

        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Drawing functionality
        canvas.addEventListener('mousedown', (e) => {
            isPainting = true;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = currentTool === 'eraser' ? 20 : 2;
            ctx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : 'source-over';
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isPainting) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.lineTo(x, y);
            ctx.stroke();
        });

        canvas.addEventListener('mouseup', () => {
            isPainting = false;
        });

        canvas.addEventListener('mouseleave', () => {
            isPainting = false;
        });
    }

    // Show system info
    function showSystemInfo() {
        alert('CircleOS v0.0.1\nA beautiful and functional operating system simulation.\n\nFeatures:\n- Multi-window support\n- Drag and drop\n- Paint application\n- File manager\n- And more!');
    }

    // Lock system
    function lockSystem() {
        document.getElementById('lock-screen').classList.remove('hidden');
        document.getElementById('pin-input').value = '';
        saveSystemState();
    }

    // Unlock system
    function unlockSystem() {
        const pin = document.getElementById('pin-input').value;
        const savedPin = localStorage.getItem('circleos-pin') || '1234';

        if (pin === savedPin) {
            document.getElementById('lock-screen').classList.add('hidden');
        } else {
            alert('Incorrect PIN. Try again.');
            document.getElementById('pin-input').value = '';
        }
    }

    // Change PIN
    function changePin() {
        const currentPin = prompt('Enter current PIN:');
        const savedPin = localStorage.getItem('circleos-pin') || '1234';

        if (currentPin === savedPin) {
            const newPin = prompt('Enter new PIN (4 digits):');
            if (newPin && newPin.length === 4 && !isNaN(newPin)) {
                localStorage.setItem('circleos-pin', newPin);
                alert('PIN changed successfully!');
            } else {
                alert('Invalid PIN. Must be 4 digits.');
            }
        } else {
            alert('Current PIN is incorrect.');
        }
    }

    // Save system state
    function saveSystemState() {
        const state = {
            activeWindows: Object.keys(activeWindows).map(id => ({
                id,
                app: activeWindows[id].app,
                position: {
                    left: activeWindows[id].element.style.left,
                    top: activeWindows[id].element.style.top
                },
                size: {
                    width: activeWindows[id].element.style.width,
                    height: activeWindows[id].element.style.height
                },
                isMinimized: activeWindows[id].isMinimized
            }))
        };
        localStorage.setItem('circleos-state', JSON.stringify(state));
    }

    // Load system state
    function loadSystemState() {
        const savedState = localStorage.getItem('circleos-state');
        if (savedState) {
            try {
                const state = JSON.parse(savedState);
                // You can implement state restoration here if needed
            } catch (e) {
                console.error('Failed to load system state:', e);
            }
        }
    }

    // Auto-lock after 1 minute of inactivity
    let inactivityTimer;
    function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(() => {
            if (localStorage.getItem('circleos-autolock') !== 'false') {
                lockSystem();
            }
        }, 60000); // 1 minute
    }

    // Reset timer on user activity
    ['mousedown', 'mousemove', 'keypress', 'touchstart'].forEach(event => {
        document.addEventListener(event, resetInactivityTimer);
    });

    resetInactivityTimer();

    // Handle window before unload to save state
    window.addEventListener('beforeunload', saveSystemState);
</script>
</body>
</html>