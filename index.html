<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CircleOS v1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.544.0/dist/umd/lucide.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8B5CF6',
                        secondary: '#EC4899',
                        accent: '#06B6D4',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .glass {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            .glass-hover {
                background: rgba(255, 255, 255, 0.15);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.3);
            }
            .window-shadow {
                box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            }
            .sidebar-icon {
                @apply relative flex items-center justify-center h-12 w-12 mt-2 mb-2 mx-auto
                bg-purple-100 text-purple-800 hover:bg-purple-200
                rounded-full hover:rounded-xl transition-all duration-300 ease-linear
                cursor-pointer;
            }
            .sidebar-tooltip {
                @apply absolute w-auto p-2 m-2 min-w-max left-14 rounded-md shadow-md
                text-purple-800 bg-white
                text-xs font-bold transition-all duration-100 scale-0 origin-left;
            }
            .sidebar-hr {
                @apply bg-purple-200 border border-purple-200 rounded-full mx-2;
            }
            .window-header {
                @apply flex items-center justify-between p-2 bg-gray-800 text-white rounded-t-lg cursor-move;
            }
            .window-content {
                @apply p-4 bg-white rounded-b-lg h-full overflow-auto;
            }
            .window-button {
                @apply w-8 h-8 flex items-center justify-center rounded-full mx-1 transition-all duration-200;
            }
            .active-window {
                @apply border-l-4 border-blue-500;
            }
            .minimized-window {
                @apply border-l-4 border-gray-500;
            }
            .clock-fullscreen {
                @apply z-50 !important;
            }
        }
    </style>
    <link rel="stylesheet" href="animations.css">
</head>
<body class="bg-gradient-to-br from-pink-300 via-purple-300 to-indigo-400 min-h-screen font-sans text-gray-900 overflow-hidden">

<!-- Background Animation -->
<div id="bg-animation" class="fixed inset-0 z-0 opacity-20"></div>

<!-- Welcome Screen -->
<div id="welcome-screen" class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="text-center text-white animate-fade-in">
        <div class="text-6xl font-bold mb-8 text-transparent bg-clip-text bg-gradient-to-r from-pink-300 to-purple-200">CircleOS</div>
        <div class="text-lg mb-4 animate-pulse">æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...</div>
        <div class="text-sm text-gray-200">è¿™å¯èƒ½ä¼šèŠ±è´¹ä¸€ç‚¹æ—¶é—´ï¼Œå¦‚æœæ— æ³•è¿›å…¥è¯·é‡æ–°è½½å…¥</div>
    </div>
</div>



<!-- Setup Wizard -->
<div id="setup-wizard" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="glass p-8 rounded-2xl w-96 animate-slide-in-center">
        <h1 class="text-2xl font-bold text-center text-white mb-6">æ¬¢è¿ä½¿ç”¨ CircleOS</h1>
        <div id="setup-step-1">
            <div class="mb-4">
                <label for="username" class="block text-sm font-medium text-white mb-2">ç”¨æˆ·å</label>
                <input type="text" id="username" class="w-full p-3 rounded-lg bg-white bg-opacity-20 border border-white border-opacity-30 text-white focus:outline-none focus:ring-2 focus:ring-primary" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
            </div>
            <button onclick="nextSetupStep(2)" class="w-full py-3 bg-primary hover:bg-primary/80 text-white font-semibold rounded-lg transition-colors duration-200">ä¸‹ä¸€æ­¥</button>
        </div>
        <div id="setup-step-2" class="hidden">
            <div class="mb-4">
                <label for="pin" class="block text-sm font-medium text-white mb-2">è®¾ç½® PIN ç </label>
                <input type="password" id="pin" maxlength="4" class="w-full p-3 rounded-lg bg-white bg-opacity-20 border border-white border-opacity-30 text-white text-center text-2xl focus:outline-none focus:ring-2 focus:ring-primary" placeholder="****">
                <div class="text-xs text-white text-center mt-2">è¯·è®¾ç½® 4 ä½æ•°å­— PIN ç </div>
            </div>
            <button onclick="nextSetupStep(3)" class="w-full py-3 bg-primary hover:bg-primary/80 text-white font-semibold rounded-lg transition-colors duration-200">ä¸‹ä¸€æ­¥</button>
        </div>
        <div id="setup-step-3" class="hidden">
            <div class="mb-4">
                <label for="confirm-pin" class="block text-sm font-medium text-white mb-2">ç¡®è®¤ PIN ç </label>
                <input type="password" id="confirm-pin" maxlength="4" class="w-full p-3 rounded-lg bg-white bg-opacity-20 border border-white border-opacity-30 text-white text-center text-2xl focus:outline-none focus:ring-2 focus:ring-primary" placeholder="****">
            </div>
            <button onclick="completeSetup()" class="w-full py-3 bg-primary hover:bg-primary/80 text-white font-semibold rounded-lg transition-colors duration-200">å®Œæˆ</button>
        </div>
    </div>
</div>

<!-- Main Container -->
<div id="main-container" class="relative z-10 flex h-screen hidden">
    <!-- System Info Button -->

    <!-- Left Sidebar -->
    <div class="sidebar bg-white w-16 flex flex-col items-center py-4 shadow-none">
        <!-- Search -->
        <div class="sidebar-icon group mb-4" id="search-button">
            <i data-lucide="search" class="w-6 h-6"></i>
            <span class="sidebar-tooltip group-hover:scale-100">Search</span>
        </div>

        <!-- Apps -->
        <div class="sidebar-icon group" data-app="notepad">
            <span class="text-xl">ğŸ“</span>
            <span class="sidebar-tooltip group-hover:scale-100">Notepad</span>
        </div>

        <div class="sidebar-icon group" data-app="files">
            <span class="text-xl">ğŸ“</span>
            <span class="sidebar-tooltip group-hover:scale-100">Files</span>
        </div>
        <div class="sidebar-icon group" data-app="browser">
            <span class="text-xl">ğŸŒ</span>
            <span class="sidebar-tooltip group-hover:scale-100">Browser</span>
        </div>
        <div class="sidebar-icon group" data-app="paint">
            <span class="text-xl">ğŸ¨</span>
            <span class="sidebar-tooltip group-hover:scale-100">Paint</span>
        </div>
        <div class="sidebar-icon group" data-app="calculator">
            <span class="text-xl">ğŸ§®</span>
            <span class="sidebar-tooltip group-hover:scale-100">è®¡ç®—å™¨</span>
        </div>
        <div class="sidebar-icon group" data-app="weather">
            <span class="text-xl">ğŸŒ¤ï¸</span>
            <span class="sidebar-tooltip group-hover:scale-100">å¤©æ°”</span>
        </div>
        <div class="sidebar-icon group" data-app="music">
            <span class="text-xl">ğŸµ</span>
            <span class="sidebar-tooltip group-hover:scale-100">éŸ³ä¹</span>
        </div>
        <div class="sidebar-icon group" data-app="clock">
            <span class="text-xl">ğŸ•</span>
            <span class="sidebar-tooltip group-hover:scale-100">æ—¶é’Ÿ</span>
        </div>
        <div class="sidebar-icon group" data-app="update">
            <span class="text-xl">ğŸ”„</span>
            <span class="sidebar-tooltip group-hover:scale-100">æ›´æ–°</span>
        </div>
        <div class="sidebar-icon group" data-app="settings">
            <span class="text-xl">âš™ï¸</span>
            <span class="sidebar-tooltip group-hover:scale-100">è®¾ç½®</span>
        </div>

        <hr class="sidebar-hr my-4">

        <!-- System Info -->
        <div class="sidebar-icon group" id="lock-button">
            <i data-lucide="lock" class="w-6 h-6"></i>
            <span class="sidebar-tooltip group-hover:scale-100">é”å®šç³»ç»Ÿ</span>
        </div>
        <div class="sidebar-icon group" id="restart-button">
            <i data-lucide="refresh-cw" class="w-6 h-6"></i>
            <span class="sidebar-tooltip group-hover:scale-100">é‡å¯ç³»ç»Ÿ</span>
        </div>
        <div class="sidebar-icon group mt-auto" id="system-info">
            <i data-lucide="info" class="w-6 h-6"></i>
            <span class="sidebar-tooltip group-hover:scale-100">System Info</span>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="search-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="glass p-8 rounded-2xl w-1/3 animate-fade-in">
            <div class="relative">
                <input type="text" id="search-input" placeholder="Search apps..." class="w-full p-4 pl-12 rounded-lg bg-white bg-opacity-20 border border-white border-opacity-30 text-white placeholder-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-6 h-6 text-white"></i>
            </div>
            <div id="search-results" class="mt-4 max-h-60 overflow-y-auto">
                <!-- Search results will be populated here -->
            </div>
        </div>
    </div>

    <!-- Windows Container -->
    <div id="windows-container" class="flex-1 relative overflow-hidden">
        <!-- Windows will be dynamically created here -->
    </div>

    <!-- Restart Confirmation Dialog -->
    <div id="restart-dialog" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="glass p-8 rounded-2xl w-96 animate-fade-in text-center">
            <div class="text-4xl mb-4">âš ï¸</div>
            <h2 class="text-2xl font-bold text-white mb-4">ç¡®è®¤é‡å¯ç³»ç»Ÿï¼Ÿ</h2>
            <p class="text-white text-opacity-80 mb-6">é‡å¯å°†å…³é—­æ‰€æœ‰æ‰“å¼€çš„åº”ç”¨ç¨‹åºã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ</p>
            <div class="flex space-x-4">
                <button onclick="cancelRestart()" class="flex-1 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors duration-200">å–æ¶ˆ</button>
                <button onclick="confirmRestart()" class="flex-1 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors duration-200">ç¡®è®¤é‡å¯</button>
            </div>
        </div>
    </div>

    <!-- Lock Screen -->
    <div id="lock-screen" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center">
        <div class="glass p-8 rounded-2xl w-96 animate-fade-in text-center">
            <h1 class="text-4xl font-bold text-white mb-8">Circle</h1>

            <!-- Liquid Glass Clock -->
            <div class="glass p-6 rounded-2xl mb-8 backdrop-blur-md border border-white/30">
                <div id="lock-screen-time" class="text-5xl font-bold text-white mb-2">00:00:00</div>
                <div id="lock-screen-date" class="text-lg text-white/80">YYYY-MM-DD</div>
            </div>

            <div class="mb-6">
                <input type="password" id="pin-input" maxlength="4" class="w-full p-3 rounded-lg bg-white bg-opacity-20 border border-white border-opacity-30 text-white text-center text-2xl focus:outline-none focus:ring-2 focus:ring-primary" placeholder="****">
            </div>
            <button id="unlock-button" class="w-full py-3 bg-primary hover:bg-primary/80 text-white font-semibold rounded-lg transition-colors duration-200">Unlock</button>
        </div>
    </div>
</div>

<script>
    // Initialize Lucide icons
    lucide.createIcons();

    // App definitions
    const apps = {

        'notepad': {
            name: 'Notepad',
            icon: 'ğŸ“',
            width: 600,
            height: 400,
            content: `
                    <div class="h-full flex flex-col">
                        <div class="bg-gray-100 p-2 flex items-center space-x-2 border-b">
                            <button onclick="exportNotepad(this)" class="px-3 py-1 bg-primary text-white rounded hover:bg-primary/80 text-sm">å¯¼å‡ºæ–‡ä»¶(txt)</button>
                            <button onclick="importNotepad(this)" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-sm">å¯¼å…¥æ–‡ä»¶(txt)</button>
                            <button onclick="saveNotepad(this)" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">å­˜æª”</button>
                            <input type="file" id="notepad-file-input" accept=".txt" class="hidden">
                        </div>
                        <textarea class="w-full flex-1 p-4 bg-white border-0 focus:ring-0 resize-none" placeholder="å¼€å§‹è¾“å…¥..."></textarea>
                    </div>
                `
        },

        'files': {
            name: 'Files',
            icon: 'ğŸ“',
            width: 750,
            height: 550,
            content: `
                    <div class="h-full flex flex-col">
                        <div class="bg-gray-100 p-4 rounded-t-lg border-b">
                            <div class="flex items-center space-x-2">
                                <button class="px-3 py-1 bg-white border rounded hover:bg-gray-50 text-sm">ğŸ“ Documents</button>
                                <button class="px-3 py-1 bg-white border rounded hover:bg-gray-50 text-sm">ğŸ“· Pictures</button>
                                <button class="px-3 py-1 bg-white border rounded hover:bg-gray-50 text-sm">ğŸµ Music</button>
                            </div>
                        </div>
                        <div id="files-dropzone" class="flex-1 p-4 overflow-auto border-2 border-dashed border-gray-300 rounded-lg m-2" ondrop="handleFileDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                            <div class="text-center mb-6">
                                <div class="text-2xl mb-2">ğŸ“</div>
                                <div class="font-medium text-gray-600">æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤å¤„</div>
                                <div class="text-sm text-gray-500">æˆ–åŒå‡»æ–‡ä»¶æ‰“å¼€</div>
                            </div>
                            <div id="files-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- Files will be added here dynamically -->
                            </div>
                        </div>
                    </div>
                `
        },
        'browser': {
            name: 'Browser',
            icon: 'ğŸŒ',
            width: 1024,
            height: 768,
            content: `
                    <div class="h-full flex flex-col">
                        <div class="bg-gray-100 p-2 flex items-center space-x-2 border-b">
                            <div class="flex-1 flex items-center bg-white rounded px-3 py-1 border">
                                <i data-lucide="search" class="w-4 h-4 text-gray-400 mr-2"></i>
                                <input type="text" id="browser-url" class="w-full border-0 focus:ring-0 text-sm" value="https://www.baidu.com" placeholder="è¾“å…¥ç½‘å€...">
                            </div>
                            <button onclick="navigateBrowser(this)" class="p-1 hover:bg-gray-200 rounded"><i data-lucide="search" class="w-4 h-4"></i></button>
                            <button onclick="refreshBrowser(this)" class="p-1 hover:bg-gray-200 rounded"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                            <button onclick="goHomeBrowser(this)" class="p-1 hover:bg-gray-200 rounded"><i data-lucide="home" class="w-4 h-4"></i></button>
                        </div>
                        <div class="flex-1 overflow-hidden relative">
                            <div id="browser-loading" class="hidden absolute inset-0 bg-white flex items-center justify-center z-10">
                                <div class="text-center">
                                    <div class="text-2xl mb-2">â³</div>
                                    <div class="text-gray-600">åŠ è½½ä¸­...</div>
                                </div>
                            </div>
                            <iframe id="browser-frame" class="w-full h-full border-0" src="https://www.baidu.com"></iframe>
                        </div>
                    </div>
                `
        },
        'paint': {
            name: 'Paint',
            icon: 'ğŸ¨',
            width: 800,
            height: 600,
            content: `
                    <div class="h-full flex">
                        <div class="w-20 bg-gray-100 border-r p-2 flex flex-col space-y-2">
                            <button class="w-12 h-12 bg-white border rounded hover:bg-gray-50 flex items-center justify-center" data-tool="brush"><i data-lucide="brush" class="w-6 h-6"></i></button>
                            <button class="w-12 h-12 bg-white border rounded hover:bg-gray-50 flex items-center justify-center" data-tool="eraser"><i data-lucide="eraser" class="w-6 h-6"></i></button>
                            <button class="w-12 h-12 bg-white border rounded hover:bg-gray-50 flex items-center justify-center" data-tool="square"><i data-lucide="square" class="w-6 h-6"></i></button>
                            <button class="w-12 h-12 bg-white border rounded hover:bg-gray-50 flex items-center justify-center" data-tool="circle"><i data-lucide="circle" class="w-6 h-6"></i></button>
                            <div class="border-t pt-2 mt-2">
                                <div class="text-xs text-center mb-2">Colors</div>
                                <div class="grid grid-cols-2 gap-1">
                                    ${['#000000', '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#FFFFFF'].map(color => `
                                        <button class="w-6 h-6 rounded-full border" style="background-color: ${color}" data-color="${color}"></button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="flex-1">
                            <canvas id="paint-canvas" class="w-full h-full bg-white cursor-crosshair"></canvas>
                        </div>
                    </div>
                `
        },
        'calculator': {
            name: 'è®¡ç®—å™¨',
            icon: 'ğŸ§®',
            width: 400,
            height: 500,
            content: `
                    <div class="w-full h-full bg-white p-4">
                        <div class="bg-gray-100 rounded-lg p-2 mb-4">
                            <input type="text" id="calc-display" class="w-full h-16 text-right text-2xl font-mono bg-white border rounded p-2" readonly value="0">
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            <button onclick="calcClear()" class="h-12 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">C</button>
                            <button onclick="calcDelete()" class="h-12 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">âŒ«</button>
                            <button onclick="calcAppend('/')" class="h-12 bg-orange-500 text-white rounded hover:bg-orange-600 transition-colors">/</button>
                            <button onclick="calcAppend('*')" class="h-12 bg-orange-500 text-white rounded hover:bg-orange-600 transition-colors">Ã—</button>

                            <button onclick="calcAppend('7')" class="h-12 bg-gray-200 rounded hover:bg-gray-300 transition-colors">7</button>
                            <button onclick="calcAppend('8')" class="h-12 bg-gray-200 rounded hover:bg-gray-300 transition-colors">8</button>
                            <button onclick="calcAppend('9')" class="h-12 bg-gray-200 rounded hover:bg-gray-300 transition-colors">9</button>
                            <button onclick="calcAppend('-')" class="h-12 bg-orange-500 text-white rounded hover:bg-orange-600 transition-colors">-</button>

                            <button onclick="calcAppend('4')" class="h-12 bg-gray-200 rounded hover:bg-gray-300 transition-colors">4</button>
                            <button onclick="calcAppend('5')" class="h-12 bg-gray-200 rounded hover:bg-gray-300 transition-colors">5</button>
                            <button onclick="calcAppend('6')" class="h-12 bg-gray-200 rounded hover:bg-gray-300 transition-colors">6</button>
                            <button onclick="calcAppend('+')" class="h-12 bg-orange-500 text-white rounded hover:bg-orange-600 transition-colors">+</button>

                            <button onclick="calcAppend('1')" class="h-12 bg-gray-200 rounded hover:bg-gray-300 transition-colors">1</button>
                            <button onclick="calcAppend('2')" class="h-12 bg-gray-200 rounded hover:bg-gray-300 transition-colors">2</button>
                            <button onclick="calcAppend('3')" class="h-12 bg-gray-200 rounded hover:bg-gray-300 transition-colors">3</button>
                            <button onclick="calcCalculate()" class="h-28 bg-primary text-white rounded hover:bg-primary/80 transition-colors row-span-2">=</button>

                            <button onclick="calcAppend('0')" class="h-12 bg-gray-200 rounded hover:bg-gray-300 transition-colors col-span-2">0</button>
                            <button onclick="calcAppend('.')" class="h-12 bg-gray-200 rounded hover:bg-gray-300 transition-colors">.</button>
                        </div>
                    </div>
                `
        },
        'weather': {
            name: 'å¤©æ°”',
            icon: 'ğŸŒ¤ï¸',
            width: 500,
            height: 400,
            content: `
                    <div class="w-full h-full bg-gradient-to-br from-blue-400 to-purple-500 p-6 text-white">
                        <div class="text-center mb-6">
                            <h2 class="text-2xl font-bold">åŒ—äº¬å¸‚</h2>
                            <p class="text-sm opacity-80">2025å¹´12æœˆ11æ—¥ æ˜ŸæœŸå››</p>
                        </div>
                        <div class="flex items-center justify-center mb-8">
                            <div class="text-8xl mr-4">â˜€ï¸</div>
                            <div>
                                <div class="text-4xl font-bold">22Â°C</div>
                                <div class="text-sm opacity-80">æ™´æœ—</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white bg-opacity-20 p-4 rounded-lg backdrop-blur-sm">
                                <div class="text-sm opacity-80">æ¹¿åº¦</div>
                                <div class="text-xl">45%</div>
                            </div>
                            <div class="bg-white bg-opacity-20 p-4 rounded-lg backdrop-blur-sm">
                                <div class="text-sm opacity-80">é£é€Ÿ</div>
                                <div class="text-xl">3.2 m/s</div>
                            </div>
                            <div class="bg-white bg-opacity-20 p-4 rounded-lg backdrop-blur-sm">
                                <div class="text-sm opacity-80">æ°”å‹</div>
                                <div class="text-xl">1013 hPa</div>
                            </div>
                            <div class="bg-white bg-opacity-20 p-4 rounded-lg backdrop-blur-sm">
                                <div class="text-sm opacity-80">èƒ½è§åº¦</div>
                                <div class="text-xl">10 km</div>
                            </div>
                        </div>
                        <div class="mt-6 text-center">
                            <button onclick="refreshWeather()" class="px-4 py-2 bg-white bg-opacity-20 rounded hover:bg-opacity-30 transition-colors backdrop-blur-sm">
                                åˆ·æ–°å¤©æ°”
                            </button>
                        </div>
                    </div>
                `
        },
        'music': {
            name: 'éŸ³ä¹',
            icon: 'ğŸµ',
            width: 600,
            height: 400,
            content: `
                    <div class="w-full h-full bg-gradient-to-br from-purple-500 to-pink-500 p-6 text-white">
                        <div class="text-center mb-6">
                            <h2 class="text-2xl font-bold">éŸ³ä¹æ’­æ”¾å™¨</h2>
                            <p class="text-sm opacity-80">äº«å—æ‚¨çš„éŸ³ä¹æ—¶å…‰</p>
                        </div>
                        <div class="flex items-center justify-center mb-8">
                            <div class="w-32 h-32 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-4xl backdrop-blur-sm">
                                ğŸµ
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="bg-white bg-opacity-20 p-4 rounded-lg backdrop-blur-sm">
                                <div class="font-bold mb-1">æ­£åœ¨æ’­æ”¾</div>
                                <div class="text-sm opacity-80">CircleOS ä¸»é¢˜æ›²</div>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span>1:23</span>
                                    <span>3:45</span>
                                </div>
                                <div class="w-full bg-white bg-opacity-30 rounded-full h-2">
                                    <div class="bg-white h-2 rounded-full" style="width: 35%"></div>
                                </div>
                            </div>
                            <div class="flex justify-center space-x-6">
                                <button onclick="musicAction('prev')" class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-colors backdrop-blur-sm">â®ï¸</button>
                                <button onclick="musicAction('play')" class="w-16 h-16 bg-white bg-opacity-30 rounded-full flex items-center justify-center hover:bg-opacity-40 transition-colors backdrop-blur-sm">â–¶ï¸</button>
                                <button onclick="musicAction('next')" class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-colors backdrop-blur-sm">â­ï¸</button>
                            </div>
                        </div>
                    </div>
                `
        },
        'clock': {
            name: 'æ—¶é’Ÿ',
            icon: 'ğŸ•',
            width: 400,
            height: 200,
            content: `
                    <div class="h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600 text-white">
                        <div class="text-center">
                            <div id="clock-display" class="text-6xl font-mono font-bold mb-4">00:00:00</div>
                            <div id="clock-date" class="text-xl mb-6">YYYY-MM-DD</div>
                            <button onclick="toggleClockFullscreen(this)" class="px-6 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg transition-colors duration-200 backdrop-blur-sm">
                                å…¨å±æ¨¡å¼
                            </button>
                        </div>
                    </div>
                `
        },
        'update': {
            name: 'ç³»ç»Ÿæ›´æ–°',
            icon: 'ğŸ”„',
            width: 500,
            height: 400,
            content: `
                    <div class="h-full flex flex-col bg-white">
                        <div class="flex-1 p-6">
                            <div class="text-center mb-8">
                                <div class="text-6xl mb-4">ğŸ”„</div>
                                <h2 class="text-2xl font-bold text-gray-800 mb-2">System Update</h2>
                                <p class="text-gray-600">CircleOS v1</p>
                            </div>

                            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-3">Current Version</h3>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Version:</span>
                                    <span class="font-mono text-blue-600">v1</span>
                                </div>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-gray-600">Build:</span>
                                    <span class="font-mono text-blue-600">2025.12.11</span>
                                </div>
                            </div>

                            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                                <div class="flex items-start">
                                    <div class="text-green-500 mr-3">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-green-800 font-semibold mb-1">Your system is up to date</h3>
                                        <p class="text-green-700 text-sm">No updates available at this time.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <h3 class="text-lg font-semibold text-gray-800">What's New in v1:</h3>
                                <div class="space-y-2">
                                    <div class="flex items-start">
                                        <span class="text-purple-500 mr-2">â€¢</span>
                                        <span class="text-gray-700">macOS-like window management with improved dragging and resizing</span>
                                    </div>
                                    <div class="flex items-start">
                                        <span class="text-purple-500 mr-2">â€¢</span>
                                        <span class="text-gray-700">Enhanced browser with tab handling</span>
                                    </div>
                                    <div class="flex items-start">
                                        <span class="text-purple-500 mr-2">â€¢</span>
                                        <span class="text-gray-700">Improved security with instant system locking</span>
                                    </div>
                                    <div class="flex items-start">
                                        <span class="text-purple-500 mr-2">â€¢</span>
                                        <span class="text-gray-700">New Update Center for system information</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="border-t p-4 flex justify-end">
                            <button onclick="closeWindow(this.closest('.window').id)" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                                Close
                            </button>
                        </div>
                    </div>
                `
        },
        'settings': {
            name: 'Settings',
            icon: 'âš™ï¸',
            width: 600,
            height: 500,
            content: `
                    <div class="h-full">
                        <div class="flex mb-6">
                            <button class="px-4 py-2 bg-primary text-white rounded-l-lg" onclick="showSettingsTab('general')">General</button>
                            <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-r-lg" onclick="showSettingsTab('security')">Security</button>
                        </div>
                        <div id="settings-general" class="space-y-6">
                            <div class="bg-white p-4 rounded-lg border">
                                <h3 class="font-semibold mb-3">System</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span>System Version</span>
                                        <span class="text-gray-600">v0.0.1</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span>Username</span>
                                        <span class="text-gray-600" id="settings-username">Loading...</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span>Auto-lock</span>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" class="sr-only peer" id="auto-lock-toggle" checked>
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-lg border">
                                <h3 class="font-semibold mb-3">Personalization</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm mb-1">Theme</label>
                                        <select class="w-full p-2 border rounded bg-white">
                                            <option>Pink & Purple</option>
                                            <option>Blue & Green</option>
                                            <option>Dark Mode</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="settings-security" class="space-y-6 hidden">
                            <div class="bg-white p-4 rounded-lg border">
                                <h3 class="font-semibold mb-3">Security</h3>
                                <div class="space-y-3">
                                    <button id="change-pin-button" class="w-full py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm">ä¿®æ”¹ PIN ç </button>
                                    <button id="lock-now-button" class="w-full py-2 bg-primary text-white rounded-lg text-sm">ç«‹å³é”å®š</button>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-lg border">
                                <h3 class="font-semibold mb-3">Data Management</h3>
                                <div class="space-y-3">
                                    <button onclick="clearUserData()" class="w-full py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-sm">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
                                    <div class="text-xs text-gray-500">æ³¨æ„ï¼šæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰ç”¨æˆ·æ•°æ®å¹¶é‡ç½®ç³»ç»Ÿ</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `
        }
    };

    // Global variables
    let activeWindows = {};
    let nextWindowId = 1;
    let isDragging = false;
    let dragOffset = { x: 0, y: 0 };
    let activeWindowElement = null;
    let currentColor = '#000000';
    let currentTool = 'brush';
    let isPainting = false;
    let userFiles = [];
    let calcExpression = '';
    let isMusicPlaying = false;

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
        initializeBackground();
        initializeEventListeners();
        initializePaintApp();
        checkFirstTime();
    });

    // Check if first time loading
    function checkFirstTime() {
        const isFirstTime = !localStorage.getItem('circleos-username');
        if (isFirstTime) {
            // First time - show welcome screen briefly then setup wizard
            document.getElementById('welcome-screen').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('welcome-screen').classList.add('hidden');
                document.getElementById('setup-wizard').classList.remove('hidden');
            }, 3000);
        } else {
            // Not first time - show welcome screen briefly then main interface
            document.getElementById('welcome-screen').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('welcome-screen').classList.add('hidden');
                document.getElementById('main-container').classList.remove('hidden');
                loadSystemState();
            }, 2000);
        }
    }

    // Update system time
    function updateSystemTime() {
        const now = new Date();
        const timeStr = now.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });

        // Update time in system info modal
        const timeElement = document.getElementById('system-time');
        if (timeElement) {
            timeElement.textContent = timeStr;
        }

        // Update desktop time
        const desktopTimeElement = document.getElementById('desktop-time');
        if (desktopTimeElement) {
            desktopTimeElement.textContent = timeStr;
        }

        // Update lock screen time
        const lockScreenTime = document.getElementById('lock-screen-time');
        if (lockScreenTime) {
            lockScreenTime.textContent = now.toLocaleTimeString('zh-CN', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Update lock screen date
        const lockScreenDate = document.getElementById('lock-screen-date');
        if (lockScreenDate) {
            lockScreenDate.textContent = now.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }
    }



    // Calculator functions
    function calcAppend(value) {
        const displays = document.querySelectorAll('[id="calc-display"]');
        displays.forEach(display => {
            if (display.value === '0' && value !== '.') {
                display.value = value;
            } else {
                display.value += value;
            }
            calcExpression = display.value;
        });
    }

    function calcClear() {
        const displays = document.querySelectorAll('[id="calc-display"]');
        displays.forEach(display => {
            display.value = '0';
            calcExpression = '';
        });
    }

    function calcDelete() {
        const displays = document.querySelectorAll('[id="calc-display"]');
        displays.forEach(display => {
            if (display.value.length > 1) {
                display.value = display.value.slice(0, -1);
            } else {
                display.value = '0';
            }
            calcExpression = display.value;
        });
    }

    function calcCalculate() {
        const displays = document.querySelectorAll('[id="calc-display"]');
        displays.forEach(display => {
            try {
                // Replace Ã— with * for evaluation
                const expression = calcExpression.replace(/Ã—/g, '*');
                const result = eval(expression);
                display.value = result;
                calcExpression = result.toString();
            } catch (e) {
                display.value = 'Error';
                calcExpression = '';
            }
        });
    }

    // Weather functions
    function refreshWeather() {
        const weatherApps = document.querySelectorAll('[data-app="weather"]');
        weatherApps.forEach(app => {
            const button = app.querySelector('button');
            if (button) {
                const originalText = button.textContent;
                button.textContent = 'åˆ·æ–°ä¸­...';
                button.disabled = true;

                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                    // Update date
                    const dateElement = app.querySelector('.text-sm.opacity-80');
                    if (dateElement && dateElement.textContent.includes('å¹´')) {
                        const now = new Date();
                        const dateStr = now.toLocaleDateString('zh-CN', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            weekday: 'long'
                        });
                        dateElement.textContent = dateStr;
                    }
                    showNotification('å¤©æ°”æ•°æ®å·²æ›´æ–°ï¼');
                }, 1500);
            }
        });
    }

    // Music player functions
    function musicAction(action) {
        const musicApps = document.querySelectorAll('[data-app="music"]');
        musicApps.forEach(app => {
            const playButton = app.querySelector('button:nth-child(2)');
            if (playButton) {
                if (action === 'play') {
                    isMusicPlaying = !isMusicPlaying;
                    playButton.textContent = isMusicPlaying ? 'â¸ï¸' : 'â–¶ï¸';
                    showNotification(isMusicPlaying ? 'éŸ³ä¹å¼€å§‹æ’­æ”¾' : 'éŸ³ä¹å·²æš‚åœ');
                } else if (action === 'prev') {
                    showNotification('æ’­æ”¾ä¸Šä¸€é¦–');
                } else if (action === 'next') {
                    showNotification('æ’­æ”¾ä¸‹ä¸€é¦–');
                }
            }
        });
    }

    // Keyboard shortcuts
    function handleKeyboardShortcuts(event) {
        // Ctrl/Cmd + key combinations
        if (event.ctrlKey || event.metaKey) {
            switch (event.key.toLowerCase()) {
                case 'n':
                    event.preventDefault();
                    openWindow('notepad');
                    break;
                case 'f':
                    event.preventDefault();
                    openWindow('files');
                    break;
                case 'c':
                    event.preventDefault();
                    openWindow('calculator');
                    break;
                case 's':
                    event.preventDefault();
                    saveAllData();
                    showNotification('æ•°æ®å·²ä¿å­˜');
                    break;
                case 'l':
                    event.preventDefault();
                    lockSystem();
                    break;
            }
        }

        // F1 for help
        if (event.key === 'F1') {
            event.preventDefault();
            showHelp();
        }


    }

    // Show notification
    function showNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-white text-gray-900 px-4 py-2 rounded-lg shadow-lg z-50 animate-slide-in-right';
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.classList.add('animate-slide-out-right');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, 3000);
    }

    // Show help
    function showHelp() {
        const helpModal = document.createElement('div');
        helpModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
        helpModal.innerHTML = `
                <div class="glass p-8 rounded-2xl w-96 animate-fade-in max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-white">å¸®åŠ©ä¸­å¿ƒ</h2>
                        <button onclick="this.closest('.fixed').remove()" class="text-white hover:text-gray-200">âœ•</button>
                    </div>
                    <div class="space-y-4 text-white">
                        <div>
                            <h3 class="font-semibold mb-2">é”®ç›˜å¿«æ·é”®</h3>
                            <div class="text-sm space-y-1">
                                <div>Ctrl/Cmd + N - æ–°å»ºè®°äº‹æœ¬</div>
                                <div>Ctrl/Cmd + F - æ‰“å¼€æ–‡ä»¶ç®¡ç†å™¨</div>
                                <div>Ctrl/Cmd + C - æ‰“å¼€è®¡ç®—å™¨</div>
                                <div>Ctrl/Cmd + S - ä¿å­˜æ•°æ®</div>
                                <div>Ctrl/Cmd + L - é”å®šç³»ç»Ÿ</div>
                                <div>F1 - æ˜¾ç¤ºå¸®åŠ©</div>
                                <div>F12 - åˆ‡æ¢è°ƒè¯•æ¨¡å¼</div>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold mb-2">ç³»ç»Ÿç‰¹æ€§</h3>
                            <div class="text-sm space-y-1">
                                <div>â€¢ å¤šçª—å£ç®¡ç†</div>
                                <div>â€¢ æ•°æ®è‡ªåŠ¨ä¿å­˜</div>
                                <div>â€¢ é¡µé¢ç¦»å¼€è‡ªåŠ¨é”å®š</div>
                                <div>â€¢ 4ä½PINç ä¿æŠ¤</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        document.body.appendChild(helpModal);
    }

    function resetAllData() {
        if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
            localStorage.clear();
            userFiles = [];
            alert('æ‰€æœ‰æ•°æ®å·²é‡ç½®');
            window.location.reload();
        }
    }

    // Setup wizard navigation
    function nextSetupStep(step) {
        if (step === 2) {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å');
                return;
            }
            document.getElementById('setup-step-1').classList.add('hidden');
            document.getElementById('setup-step-2').classList.remove('hidden');
        } else if (step === 3) {
            const pin = document.getElementById('pin').value;
            if (pin.length !== 4 || isNaN(pin)) {
                alert('è¯·è¾“å…¥4ä½æ•°å­—PINç ');
                return;
            }
            document.getElementById('setup-step-2').classList.add('hidden');
            document.getElementById('setup-step-3').classList.remove('hidden');
        }
    }

    // Complete setup
    function completeSetup() {
        const username = document.getElementById('username').value.trim();
        const pin = document.getElementById('pin').value;
        const confirmPin = document.getElementById('confirm-pin').value;

        if (pin !== confirmPin) {
            alert('PINç ä¸åŒ¹é…ï¼Œè¯·é‡æ–°è¾“å…¥');
            return;
        }

        // Save user data
        localStorage.setItem('circleos-username', username);
        localStorage.setItem('circleos-pin', pin);

        // Hide setup wizard and show main interface
        document.getElementById('setup-wizard').classList.add('hidden');
        document.getElementById('main-container').classList.remove('hidden');

        // Show welcome message
        setTimeout(() => {
            alert(`æ¬¢è¿ä½¿ç”¨ CircleOSï¼Œ${username}ï¼`);
        }, 500);
    }

    // Initialize background animation
    function initializeBackground() {
        const canvas = document.createElement('canvas');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        document.getElementById('bg-animation').appendChild(canvas);

        const ctx = canvas.getContext('2d');
        const lines = [];
        const lineCount = 15;

        // Create pink lines
        for (let i = 0; i < lineCount; i++) {
            lines.push({
                x1: Math.random() * canvas.width,
                y1: Math.random() * canvas.height,
                x2: Math.random() * canvas.width,
                y2: Math.random() * canvas.height,
                thickness: Math.random() * 3 + 1,
                opacity: Math.random() * 0.5 + 0.2,
                speed: Math.random() * 0.5 + 0.2,
                angle: Math.random() * Math.PI * 2
            });
        }

        function animate() {
            // Draw solid purple background
            ctx.fillStyle = '#6B21A8';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw pink lines
            lines.forEach(line => {
                ctx.save();
                ctx.globalAlpha = line.opacity;
                ctx.strokeStyle = '#EC4899';
                ctx.lineWidth = line.thickness;
                ctx.lineCap = 'round';

                // Add glow effect
                ctx.shadowColor = '#EC4899';
                ctx.shadowBlur = 15;

                ctx.beginPath();
                ctx.moveTo(line.x1, line.y1);
                ctx.lineTo(line.x2, line.y2);
                ctx.stroke();
                ctx.restore();

                // Animate lines
                line.angle += line.speed * 0.01;
                line.x1 += Math.cos(line.angle) * line.speed;
                line.y1 += Math.sin(line.angle) * line.speed;
                line.x2 += Math.cos(line.angle + Math.PI/2) * line.speed;
                line.y2 += Math.sin(line.angle + Math.PI/2) * line.speed;

                // Wrap around edges
                if (line.x1 < 0) line.x1 = canvas.width;
                if (line.x1 > canvas.width) line.x1 = 0;
                if (line.y1 < 0) line.y1 = canvas.height;
                if (line.y1 > canvas.height) line.y1 = 0;
                if (line.x2 < 0) line.x2 = canvas.width;
                if (line.x2 > canvas.width) line.x2 = 0;
                if (line.y2 < 0) line.y2 = canvas.height;
                if (line.y2 > canvas.height) line.y2 = 0;
            });

            requestAnimationFrame(animate);
        }

        // Handle resize
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        animate();
    }

    // Initialize event listeners
    function initializeEventListeners() {
        // Handle visibility change
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Page hidden - lock system only if main container is visible
                const mainContainer = document.getElementById('main-container');
                if (mainContainer && !mainContainer.classList.contains('hidden')) {
                    lockSystem();
                    saveAllData();
                }
            }
        });

        // Handle before unload
        window.addEventListener('beforeunload', () => {
            // Save all application data
            saveAllData();
        });

        // Update system time
        setInterval(updateSystemTime, 1000);
        // Load user data on settings open
        document.addEventListener('click', (e) => {
            if (e.target.closest('[data-app="settings"]')) {
                setTimeout(() => {
                    document.getElementById('settings-username').textContent = localStorage.getItem('circleos-username') || 'Guest';
                    document.getElementById('auto-lock-toggle').checked = localStorage.getItem('circleos-autolock') !== 'false';
                }, 100);
            }
        });

        // Auto-lock toggle
        document.addEventListener('change', (e) => {
            if (e.target.id === 'auto-lock-toggle') {
                localStorage.setItem('circleos-autolock', e.target.checked ? 'true' : 'false');
            }
        });
        // App launchers
        document.querySelectorAll('[data-app]').forEach(launcher => {
            launcher.addEventListener('click', () => {
                const appName = launcher.getAttribute('data-app');
                openWindow(appName);
            });
        });

        // Search functionality
        document.getElementById('search-button').addEventListener('click', () => {
            document.getElementById('search-modal').classList.toggle('hidden');
            document.getElementById('search-input').focus();
        });

        document.getElementById('search-input').addEventListener('input', handleSearch);

        // Close search modal when clicking outside
        document.getElementById('search-modal').addEventListener('click', (e) => {
            if (e.target.id === 'search-modal') {
                document.getElementById('search-modal').classList.add('hidden');
            }
        });

        // Lock button
        document.getElementById('lock-button').addEventListener('click', lockSystem);

        // System info
        document.getElementById('system-info').addEventListener('click', showSystemInfo);

        // Lock screen functionality
        document.getElementById('unlock-button').addEventListener('click', unlockSystem);
        document.getElementById('pin-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                unlockSystem();
            }
        });

        // Settings buttons
        document.addEventListener('click', (e) => {
            if (e.target.id === 'lock-now-button') {
                lockSystem();
            }
            if (e.target.id === 'change-pin-button') {
                changePin();
            }
        });

        // Click outside to focus window
        document.getElementById('windows-container').addEventListener('click', (e) => {
            if (e.target.id === 'windows-container') {
                focusWindow(null);
            }
        });
    }

    // Handle search
    function handleSearch(e) {
        const query = e.target.value.toLowerCase();
        const results = document.getElementById('search-results');

        if (query.length === 0) {
            results.innerHTML = '';
            return;
        }

        const filteredApps = Object.entries(apps).filter(([key, app]) =>
            app.name.toLowerCase().includes(query)
        );

        results.innerHTML = filteredApps.map(([key, app]) => `
                <div class="flex items-center p-2 hover:bg-white hover:bg-opacity-10 rounded cursor-pointer animate-fade-in" onclick="openWindow('${key}'); document.getElementById('search-modal').classList.add('hidden')">
                    <span class="text-xl mr-3">${app.icon}</span>
                    <span>${app.name}</span>
                </div>
            `).join('');
    }

    // Open a new window
    function openWindow(appName) {
        const app = apps[appName];
        if (!app) return;

        const windowId = `window-${nextWindowId++}`;
        const windowElement = document.createElement('div');
        windowElement.id = windowId;
        windowElement.className = 'fixed glass window-shadow rounded-lg overflow-hidden animate-slide-in-center z-20 transition-all duration-200';
        windowElement.style.width = `${app.width}px`;
        windowElement.style.height = `${app.height}px`;
        windowElement.style.left = '50%';
        windowElement.style.top = '50%';
        windowElement.style.transform = 'translate(-50%, -50%)';

        windowElement.innerHTML = `
                <div class="window-header" data-window-id="${windowId}">
                    <div class="flex items-center">
                        <span class="text-xl mr-2">${app.icon}</span>
                        <span>${app.name}</span>
                    </div>
                    <div class="flex">
                        <button class="window-button hover:bg-gray-700" onclick="minimizeWindow('${windowId}')">
                            <i data-lucide="minus" class="w-4 h-4"></i>
                        </button>
                        <button class="window-button hover:bg-gray-700" onclick="maximizeWindow('${windowId}')">
                            <i data-lucide="maximize" class="w-4 h-4"></i>
                        </button>
                        <button class="window-button hover:bg-red-500" onclick="closeWindow('${windowId}')">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                <div class="window-content">
                    ${app.content}
                </div>
                <div class="window-resize-handle absolute bottom-0 right-0 w-4 h-4 bg-gray-400 cursor-se-resize" style="border-top-left-radius: 4px;"></div>
            `;

        document.getElementById('windows-container').appendChild(windowElement);
        lucide.createIcons();

        // Add to active windows
        activeWindows[windowId] = {
            app: appName,
            element: windowElement,
            isMinimized: false,
            originalSize: { width: app.width, height: app.height },
            originalPosition: { left: windowElement.style.left, top: windowElement.style.top }
        };

        // Update sidebar indicator
        updateSidebarIndicators();

        // Focus this window
        focusWindow(windowId);

        // Window dragging disabled as requested

        // Initialize app-specific functionality
        if (appName === 'paint') {
            initializePaintCanvas(windowId);
        } else if (appName === 'files') {
            setTimeout(() => {
                loadFiles();
            }, 100);
        } else if (appName === 'notepad') {
            setTimeout(() => {
                // Load saved notepad data
                const appData = localStorage.getItem('circleos-app-data');
                if (appData) {
                    const data = JSON.parse(appData);
                    const notepadIndex = Object.keys(activeWindows).filter(id =>
                        activeWindows[id].app === 'notepad'
                    ).length - 1;

                    const savedData = data[`notepad-${notepadIndex}`];
                    if (savedData) {
                        const textarea = windowElement.querySelector('textarea');
                        if (textarea) {
                            textarea.value = savedData;
                        }
                    }
                }

                // Save data on change
                const textarea = windowElement.querySelector('textarea');
                if (textarea) {
                    textarea.addEventListener('input', saveAllData);
                }
            }, 100);
        } else if (appName === 'clock') {
            initializeClockApp(windowId);
        } else if (appName === 'browser') {
            setTimeout(() => {
                // Add enter key support for URL input
                const urlInput = windowElement.querySelector('#browser-url');
                if (urlInput) {
                    urlInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            navigateBrowser(urlInput.closest('.fixed').querySelector('button[onclick="navigateBrowser(this)"]'));
                        }
                    });
                }
            }, 100);
        }
    }

    // Initialize window dragging and resizing
    function initializeWindowDragging(windowElement) {
        const header = windowElement.querySelector('.window-header');
        let isDragging = false;
        let dragStartX, dragStartY;
        let windowStartLeft, windowStartTop;

        // Window dragging
        header.addEventListener('mousedown', (e) => {
            // Don't drag if clicking on window buttons
            if (e.target.closest('.window-button')) return;

            isDragging = true;
            dragStartX = e.clientX;
            dragStartY = e.clientY;

            // Get current window position
            const computedStyle = window.getComputedStyle(windowElement);
            windowStartLeft = parseInt(computedStyle.left) || 0;
            windowStartTop = parseInt(computedStyle.top) || 0;

            // Focus window
            focusWindow(windowElement.id);

            e.preventDefault();
        });

        // Handle mouse move for dragging
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;

            const container = document.getElementById('windows-container');
            const containerRect = container.getBoundingClientRect();

            // Calculate new position
            const deltaX = e.clientX - dragStartX;
            const deltaY = e.clientY - dragStartY;

            let newLeft = windowStartLeft + deltaX;
            let newTop = windowStartTop + deltaY;

            // Constrain to container boundaries
            newLeft = Math.max(0, Math.min(newLeft, containerRect.width - windowElement.offsetWidth));
            newTop = Math.max(0, Math.min(newTop, containerRect.height - windowElement.offsetHeight));

            // Update position
            windowElement.style.left = `${newLeft}px`;
            windowElement.style.top = `${newTop}px`;
            windowElement.style.transform = 'none';
        });

        // Stop dragging on mouse up
        document.addEventListener('mouseup', () => {
            isDragging = false;
        });
    }

    // Maximize/minimize window function
    function toggleMaximize(windowElement) {
        const container = document.getElementById('windows-container');
        const containerRect = container.getBoundingClientRect();

        // Check if already maximized
        if (windowElement.classList.contains('maximized')) {
            // Restore to previous size and position
            const restoreData = windowElement.dataset.restoreData;
            if (restoreData) {
                const { width, height, left, top } = JSON.parse(restoreData);
                windowElement.style.width = `${width}px`;
                windowElement.style.height = `${height}px`;
                windowElement.style.left = `${left}px`;
                windowElement.style.top = `${top}px`;
            }
            windowElement.classList.remove('maximized');
        } else {
            // Save current size and position
            const rect = windowElement.getBoundingClientRect();
            const containerLeft = containerRect.left;
            const containerTop = containerRect.top;

            windowElement.dataset.restoreData = JSON.stringify({
                width: rect.width,
                height: rect.height,
                left: rect.left - containerLeft,
                top: rect.top - containerTop
            });

            // Maximize to fill container
            windowElement.style.width = `${containerRect.width}px`;
            windowElement.style.height = `${containerRect.height}px`;
            windowElement.style.left = '0px';
            windowElement.style.top = '0px';
            windowElement.classList.add('maximized');
        }
    }

    // Handle mouse movement for dragging
    document.addEventListener('mousemove', (e) => {
        if (!isDragging || !activeWindowElement) return;

        const container = document.getElementById('windows-container');
        const containerRect = container.getBoundingClientRect();

        let newX = e.clientX - dragOffset.x - containerRect.left;
        let newY = e.clientY - dragOffset.y - containerRect.top;

        // Constrain to container
        newX = Math.max(0, Math.min(newX, containerRect.width - activeWindowElement.offsetWidth));
        newY = Math.max(0, Math.min(newY, containerRect.height - activeWindowElement.offsetHeight));

        // Update position
        activeWindowElement.style.left = `${newX}px`;
        activeWindowElement.style.top = `${newY}px`;
        activeWindowElement.style.transform = 'none';
    });

    // Handle mouse up to stop dragging
    document.addEventListener('mouseup', () => {
        isDragging = false;
        activeWindowElement = null;
    });

    // Focus a window
    function focusWindow(windowId) {
        // Remove focus from all windows
        Object.values(activeWindows).forEach(window => {
            window.element.classList.remove('z-30');
            window.element.classList.add('z-20');
        });

        // Focus the selected window
        if (windowId && activeWindows[windowId]) {
            activeWindows[windowId].element.classList.remove('z-20');
            activeWindows[windowId].element.classList.add('z-30');
        }
    }

    // Minimize a window
    function minimizeWindow(windowId) {
        const window = activeWindows[windowId];
        if (!window) return;

        if (window.isMinimized) {
            // Restore window
            window.element.style.display = 'block';
            window.element.style.width = `${window.originalSize.width}px`;
            window.element.style.height = `${window.originalSize.height}px`;
            window.element.style.left = window.originalPosition.left;
            window.element.style.top = window.originalPosition.top;
            window.isMinimized = false;
        } else {
            // Minimize window
            window.originalPosition = {
                left: window.element.style.left,
                top: window.element.style.top
            };
            window.element.style.display = 'none';
            window.isMinimized = true;
        }

        updateSidebarIndicators();
    }

    // Maximize a window
    function maximizeWindow(windowId) {
        const window = activeWindows[windowId];
        if (!window) return;

        const container = document.getElementById('windows-container');
        const containerRect = container.getBoundingClientRect();

        if (window.element.classList.contains('maximized')) {
            // Restore original size and position
            window.element.style.width = `${window.originalSize.width}px`;
            window.element.style.height = `${window.originalSize.height}px`;
            window.element.style.left = window.originalPosition.left;
            window.element.style.top = window.originalPosition.top;
            window.element.style.transform = 'translate(-50%, -50%)';
            window.element.classList.remove('maximized');
        } else {
            // Save original size and position
            window.originalPosition = {
                left: window.element.style.left,
                top: window.element.style.top
            };

            // Maximize to fill container
            window.element.style.width = `${containerRect.width}px`;
            window.element.style.height = `${containerRect.height}px`;
            window.element.style.left = '0px';
            window.element.style.top = '0px';
            window.element.style.transform = 'none';
            window.element.classList.add('maximized');
        }
    }

    // Close a window
    function closeWindow(windowId) {
        const window = activeWindows[windowId];
        if (!window) return;

        window.element.classList.add('animate-slide-out-center');
        setTimeout(() => {
            window.element.remove();
            delete activeWindows[windowId];
            updateSidebarIndicators();
        }, 200);
    }

    // Update sidebar indicators
    function updateSidebarIndicators() {
        // Clear all indicators
        document.querySelectorAll('.sidebar-icon').forEach(icon => {
            icon.classList.remove('active-window', 'minimized-window');
        });

        // Add indicators for open windows
        const appWindows = {};
        Object.values(activeWindows).forEach(window => {
            if (!appWindows[window.app] || !window.isMinimized) {
                appWindows[window.app] = window.isMinimized;
            }
        });

        // Update icons
        Object.entries(appWindows).forEach(([appName, isMinimized]) => {
            const icon = document.querySelector(`[data-app="${appName}"]`);
            if (icon) {
                icon.classList.add(isMinimized ? 'minimized-window' : 'active-window');
            }
        });
    }

    // Initialize paint app
    function initializePaintApp() {
        document.addEventListener('click', (e) => {
            if (e.target.closest('[data-tool]')) {
                currentTool = e.target.closest('[data-tool]').dataset.tool;
                document.querySelectorAll('[data-tool]').forEach(btn => btn.classList.remove('bg-primary', 'text-white'));
                e.target.closest('[data-tool]').classList.add('bg-primary', 'text-white');
            }

            if (e.target.closest('[data-color]')) {
                currentColor = e.target.closest('[data-color]').dataset.color;
            }
        });
    }

    // Initialize paint canvas for a specific window
    function initializePaintCanvas(windowId) {
        const windowElement = document.getElementById(windowId);
        const canvas = windowElement.querySelector('#paint-canvas');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');

        // Set canvas size
        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
        }

        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Drawing functionality
        canvas.addEventListener('mousedown', (e) => {
            isPainting = true;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = currentTool === 'eraser' ? 20 : 2;
            ctx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : 'source-over';
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isPainting) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.lineTo(x, y);
            ctx.stroke();
        });

        canvas.addEventListener('mouseup', () => {
            isPainting = false;
        });

        canvas.addEventListener('mouseleave', () => {
            isPainting = false;
        });
    }

    // Show system info
    function showSystemInfo() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
        modal.innerHTML = `
                <div class="glass p-6 rounded-2xl w-96 animate-slide-in-center">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-white">System Info</h2>
                        <button onclick="this.closest('.fixed').remove()" class="text-white hover:text-gray-300">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="mb-4 space-y-2">
                        <button onclick="rebootSystem()" class="w-full py-2 bg-primary hover:bg-primary/80 text-white rounded-lg">é‡å¯ç³»ç»Ÿ</button>
                    </div>
                    <div class="text-white text-sm space-y-2">
                        <div><strong>System:</strong> CircleOS v1</div>
                        <div><strong>User:</strong> ${localStorage.getItem('circleos-username') || 'Guest'}</div>
                        <div><strong>Mode:</strong> ${localStorage.getItem('circleos-mode') || 'Standard'}</div>
                        <div><strong>Windows:</strong> ${Object.keys(activeWindows).length}</div>
                        <div><strong>Files:</strong> ${userFiles.length}</div>
                        <div><strong>Time:</strong> <span id="system-time"></span></div>
                    </div>
                </div>
            `;
        document.body.appendChild(modal);
        lucide.createIcons();

        // Update time
        updateSystemTime();
    }

    // Reboot system
    function rebootSystem() {
        showBootScreen();
    }

    // Shutdown system - removed as per requirements
    function shutdownSystem() {
        alert('å…³æœºåŠŸèƒ½å·²ç¦ç”¨');
    }

    // Show boot screen
    function showBootScreen() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black z-50 flex flex-col items-center justify-center';
        modal.innerHTML = `
                <div class="text-center">
                    <div class="text-4xl font-bold mb-8 text-transparent bg-clip-text bg-gradient-to-r from-pink-300 to-purple-200">CircleOS</div>
                    <div class="w-64 h-2 bg-gray-800 rounded-full overflow-hidden mb-4">
                        <div id="boot-progress" class="h-full bg-primary" style="width: 0%"></div>
                    </div>
                    <div id="boot-status" class="text-transparent bg-clip-text bg-gradient-to-r from-pink-300 to-purple-200 text-sm">æ­£åœ¨å¯åŠ¨ç³»ç»Ÿ...</div>
                </div>
            `;
        document.body.appendChild(modal);

        let progress = 0;
        const progressBar = document.getElementById('boot-progress');
        const statusText = document.getElementById('boot-status');
        let rKeyCount = 0;
        let tKeyCount = 0;

        const bootSteps = [
            'åˆå§‹åŒ–ç³»ç»Ÿ...',
            'åŠ è½½ç”¨æˆ·é…ç½®...',
            'æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿ...',
            'å¯åŠ¨æœåŠ¡...',
            'å‡†å¤‡æ¡Œé¢...',
            'å®Œæˆå¯åŠ¨'
        ];

        // Listen for key presses during boot
        function handleBootKeyPress(e) {
            if (e.key.toLowerCase() === 'r') {
                rKeyCount++;
                if (rKeyCount >= 3) {
                    clearInterval(bootInterval);
                    modal.remove();
                    document.removeEventListener('keydown', handleBootKeyPress);
                    enterSafeMode();
                }
            } else if (e.key.toLowerCase() === 't') {
                tKeyCount++;
                if (tKeyCount >= 3) {
                    clearInterval(bootInterval);
                    modal.remove();
                    document.removeEventListener('keydown', handleBootKeyPress);
                    enterTerminalMode();
                }
            } else {
                rKeyCount = 0;
                tKeyCount = 0;
            }
        }

        document.addEventListener('keydown', handleBootKeyPress);

        const bootInterval = setInterval(() => {
            progress += 2;
            progressBar.style.width = progress + '%';

            const stepIndex = Math.floor(progress / 20);
            if (stepIndex < bootSteps.length) {
                statusText.textContent = bootSteps[stepIndex];
            }

            if (progress >= 100) {
                clearInterval(bootInterval);
                document.removeEventListener('keydown', handleBootKeyPress);
                setTimeout(() => {
                    modal.remove();
                    document.getElementById('main-container').classList.remove('hidden');
                    document.getElementById('welcome-screen').classList.add('hidden');


                }, 500);
            }
        }, 100);
    }

    // Enter safe mode
    function enterSafeMode() {
        localStorage.setItem('circleos-mode', 'Safe Mode');
        // Redirect to safe mode page
        window.location.href = 'safe_mode.html';
    }

    // Exit safe mode
    function exitSafeMode() {
        localStorage.setItem('circleos-mode', 'Standard');
        const safeModeDiv = document.getElementById('safe-mode');
        if (safeModeDiv) {
            safeModeDiv.remove();
        }
        showBootScreen();
    }

    // Enter terminal mode
    function enterTerminalMode() {
        const terminalDiv = document.createElement('div');
        terminalDiv.className = 'fixed inset-0 bg-black z-50 flex flex-col items-center justify-center';
        terminalDiv.innerHTML = `
                <div class="text-center text-white">
                    <div class="text-4xl font-bold mb-8">Terminal Mode</div>
                    <div class="bg-gray-900 p-4 rounded-lg mb-8 text-green-400 font-mono">
                        <div>Welcome to CircleOS Terminal</div>
                        <div>This feature is under development...</div>
                        <div id="countdown">Restarting in 3 seconds...</div>
                    </div>
                </div>
            `;
        document.body.appendChild(terminalDiv);

        let countdown = 3;
        const countdownEl = document.getElementById('countdown');

        const countdownInterval = setInterval(() => {
            countdown--;
            countdownEl.textContent = `Restarting in ${countdown} seconds...`;

            if (countdown <= 0) {
                clearInterval(countdownInterval);
                terminalDiv.remove();
                showBootScreen();
            }
        }, 1000);
    }

    // Handle file drop
    function handleFileDrop(event) {
        event.preventDefault();
        const dropzone = document.getElementById('files-dropzone');
        dropzone.classList.remove('border-blue-500', 'bg-blue-50');
        dropzone.classList.add('border-gray-300');

        const files = Array.from(event.dataTransfer.files);
        files.forEach(file => {
            const fileData = {
                id: Date.now() + Math.random(),
                name: file.name,
                type: file.type,
                size: file.size,
                date: new Date().toLocaleDateString()
            };

            userFiles.push(fileData);
            addFileToUI(fileData);
        });

        saveFiles();
    }

    // Handle drag over
    function handleDragOver(event) {
        event.preventDefault();
        const dropzone = document.getElementById('files-dropzone');
        dropzone.classList.remove('border-gray-300');
        dropzone.classList.add('border-blue-500', 'bg-blue-50');
    }

    // Handle drag leave
    function handleDragLeave(event) {
        event.preventDefault();
        const dropzone = document.getElementById('files-dropzone');
        dropzone.classList.remove('border-blue-500', 'bg-blue-50');
        dropzone.classList.add('border-gray-300');
    }

    // Add file to UI
    function addFileToUI(file) {
        const filesList = document.getElementById('files-list');
        if (!filesList) return;

        const fileIcon = getFileIcon(file.type);
        const fileSize = formatFileSize(file.size);

        const fileElement = document.createElement('div');
        fileElement.className = 'flex items-center p-3 bg-white rounded-lg hover:bg-gray-50 cursor-pointer border animate-fade-in';
        fileElement.setAttribute('data-file-id', file.id);
        fileElement.innerHTML = `
                <span class="text-2xl mr-3">${fileIcon}</span>
                <div class="flex-1">
                    <div class="font-medium truncate" title="${file.name}">${file.name}</div>
                    <div class="text-xs text-gray-500">${fileSize} - ${file.date}</div>
                </div>
            `;

        // Double click to open file
        fileElement.addEventListener('dblclick', () => {
            openFile(file);
        });

        filesList.appendChild(fileElement);
    }

    // Get file icon based on type
    function getFileIcon(type) {
        if (type.startsWith('image/')) return 'ğŸ“·';
        if (type.startsWith('text/')) return 'ğŸ“„';
        if (type.includes('pdf')) return 'ğŸ“„';
        if (type.includes('word')) return 'ğŸ“„';
        if (type.includes('excel')) return 'ğŸ“Š';
        if (type.includes('powerpoint')) return 'ğŸ“º';
        if (type.includes('zip')) return 'ğŸ“¦';
        if (type.startsWith('audio/')) return 'ğŸµ';
        if (type.startsWith('video/')) return 'ğŸ¬';
        return 'ğŸ“„';
    }

    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Open file
    function openFile(file) {
        alert(`æ­£åœ¨æ‰“å¼€æ–‡ä»¶: ${file.name}\n\næ–‡ä»¶ç±»å‹: ${file.type}\næ–‡ä»¶å¤§å°: ${formatFileSize(file.size)}`);
    }

    // Save files to localStorage
    function saveFiles() {
        localStorage.setItem('circleos-files', JSON.stringify(userFiles));
    }

    // Load files from localStorage
    function loadFiles() {
        const savedFiles = localStorage.getItem('circleos-files');
        if (savedFiles) {
            userFiles = JSON.parse(savedFiles);
            userFiles.forEach(file => {
                addFileToUI(file);
            });
        }
    }

    // Show settings tab
    function showSettingsTab(tab) {
        document.getElementById('settings-general').classList.add('hidden');
        document.getElementById('settings-security').classList.add('hidden');
        document.getElementById('settings-' + tab).classList.remove('hidden');
    }

    // Clear user data
    function clearUserData() {
        if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç”¨æˆ·æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
            localStorage.clear();
            alert('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤ã€‚ç³»ç»Ÿå°†é‡æ–°å¯åŠ¨ã€‚');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }
    }

    // Lock system
    function lockSystem() {
        // Hide main container and show lock screen
        document.getElementById('main-container').classList.add('hidden');
        document.getElementById('lock-screen').classList.remove('hidden');
        document.getElementById('pin-input').value = '';

        // Update lock screen time immediately
        updateLockScreenTime();

        // Save current system state
        saveAllData();

        console.log('System locked');
    }

    // Unlock system
    function unlockSystem() {
        const pin = document.getElementById('pin-input').value;
        const savedPin = localStorage.getItem('circleos-pin') || '1234';

        if (pin === savedPin) {
            document.getElementById('lock-screen').classList.add('hidden');
            document.getElementById('main-container').classList.remove('hidden');
            loadSystemState();
        } else {
            alert('PINç é”™è¯¯ï¼Œè¯·é‡è¯•');
            document.getElementById('pin-input').value = '';
        }
    }

    // Change PIN
    function changePin() {
        const currentPin = prompt('Enter current PIN:');
        const savedPin = localStorage.getItem('circleos-pin') || '1234';

        if (currentPin === savedPin) {
            const newPin = prompt('Enter new PIN (4 digits):');
            if (newPin && newPin.length === 4 && !isNaN(newPin)) {
                localStorage.setItem('circleos-pin', newPin);
                alert('PIN changed successfully!');
            } else {
                alert('Invalid PIN. Must be 4 digits.');
            }
        } else {
            alert('Current PIN is incorrect.');
        }
    }

    // Save all application data
    function saveAllData() {
        // Save window state
        const windowState = {
            activeWindows: Object.keys(activeWindows).map(id => ({
                id,
                app: activeWindows[id].app,
                position: {
                    left: activeWindows[id].element.style.left,
                    top: activeWindows[id].element.style.top
                },
                size: {
                    width: activeWindows[id].element.style.width,
                    height: activeWindows[id].element.style.height
                },
                isMinimized: activeWindows[id].isMinimized
            }))
        };
        localStorage.setItem('circleos-state', JSON.stringify(windowState));

        // Save application data
        const appData = {};

        // Save notepad data - fix for data loss issue
        const notepadWindows = document.querySelectorAll('[data-app="notepad"]');
        notepadWindows.forEach((el, index) => {
            const textarea = el.querySelector('textarea');
            if (textarea) {
                appData[`notepad-${index}`] = textarea.value;
            }
        });

        localStorage.setItem('circleos-app-data', JSON.stringify(appData));
    }

    // Load system state
    function loadSystemState() {
        const savedState = localStorage.getItem('circleos-state');
        if (savedState) {
            try {
                const state = JSON.parse(savedState);
                // Restore application data
                loadAppData();
            } catch (e) {
                console.error('Failed to load system state:', e);
            }
        }
    }

    // Load application data
    function loadAppData() {
        const appData = localStorage.getItem('circleos-app-data');
        if (appData) {
            try {
                const data = JSON.parse(appData);
                // Data will be loaded when apps are opened
            } catch (e) {
                console.error('Failed to load app data:', e);
            }
        }
    }

    // Auto-lock after 1 minute of inactivity
    let inactivityTimer;
    function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(() => {
            if (localStorage.getItem('circleos-autolock') !== 'false') {
                lockSystem();
            }
        }, 60000); // 1 minute
    }

    // Reset timer on user activity
    ['mousedown', 'mousemove', 'keypress', 'touchstart'].forEach(event => {
        document.addEventListener(event, resetInactivityTimer);
    });

    resetInactivityTimer();

    // Initialize clock app
    function initializeClockApp(windowId) {
        const windowElement = document.getElementById(windowId);
        if (!windowElement) return;

        // Update clock immediately
        updateClockDisplay(windowElement);

        // Set interval to update clock every second
        const clockInterval = setInterval(() => {
            updateClockDisplay(windowElement);
        }, 1000);

        // Store interval ID for cleanup when window is closed
        windowElement.clockInterval = clockInterval;
    }

    // Update clock display
    function updateClockDisplay(windowElement) {
        const now = new Date();

        // Update time
        const timeDisplay = windowElement.querySelector('#clock-display');
        if (timeDisplay) {
            timeDisplay.textContent = now.toLocaleTimeString('zh-CN', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Update date
        const dateDisplay = windowElement.querySelector('#clock-date');
        if (dateDisplay) {
            dateDisplay.textContent = now.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }
    }

    // Toggle clock fullscreen
    function toggleClockFullscreen(button) {
        const windowElement = button.closest('.fixed');
        if (!windowElement) return;

        if (windowElement.classList.contains('clock-fullscreen')) {
            // Exit fullscreen
            windowElement.classList.remove('clock-fullscreen');
            windowElement.style.width = windowElement.originalSize.width;
            windowElement.style.height = windowElement.originalSize.height;
            windowElement.style.left = windowElement.originalPosition.left;
            windowElement.style.top = windowElement.originalPosition.top;
            windowElement.style.transform = windowElement.originalTransform;
            button.textContent = 'å…¨å±æ¨¡å¼';

            // Show window controls
            const header = windowElement.querySelector('.window-header');
            if (header) header.style.display = 'flex';
        } else {
            // Enter fullscreen
            windowElement.originalSize = {
                width: windowElement.style.width,
                height: windowElement.style.height
            };
            windowElement.originalPosition = {
                left: windowElement.style.left,
                top: windowElement.style.top
            };
            windowElement.originalTransform = windowElement.style.transform;

            windowElement.classList.add('clock-fullscreen');
            windowElement.style.width = '100vw';
            windowElement.style.height = '100vh';
            windowElement.style.left = '0';
            windowElement.style.top = '0';
            windowElement.style.transform = 'none';
            button.textContent = 'é€€å‡ºå…¨å±';

            // Hide window controls
            const header = windowElement.querySelector('.window-header');
            if (header) header.style.display = 'none';
        }
    }

    // Notepad functions
    function exportNotepad(button) {
        const windowElement = button.closest('.fixed');
        const textarea = windowElement.querySelector('textarea');
        const content = textarea.value;

        if (!content.trim()) {
            alert('æ–‡ä»¶å†…å®¹ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º');
            return;
        }

        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `notepad_${new Date().toISOString().slice(0, 10)}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showNotification('æ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼');
    }

    function importNotepad(button) {
        const fileInput = document.getElementById('notepad-file-input');
        fileInput.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const windowElement = button.closest('.fixed');
                    const textarea = windowElement.querySelector('textarea');
                    textarea.value = e.target.result;
                    showNotification('æ–‡ä»¶å¯¼å…¥æˆåŠŸï¼');
                };
                reader.readAsText(file);
            }
        };
        fileInput.click();
    }

    function saveNotepad(button) {
        const windowElement = button.closest('.fixed');
        const textarea = windowElement.querySelector('textarea');
        const content = textarea.value;

        // Save to localStorage
        const appData = JSON.parse(localStorage.getItem('circleos-app-data') || '{}');
        const notepadWindows = document.querySelectorAll('[data-app="notepad"]');
        const currentIndex = Array.from(notepadWindows).indexOf(windowElement);
        appData[`notepad-${currentIndex}`] = content;
        localStorage.setItem('circleos-app-data', JSON.stringify(appData));

        showNotification('æ–‡ä»¶å·²ä¿å­˜ï¼');
    }

    // Browser functions
    function navigateBrowser(button) {
        const windowElement = button.closest('.fixed');
        const urlInput = windowElement.querySelector('#browser-url');
        const iframe = windowElement.querySelector('#browser-frame');
        const loading = windowElement.querySelector('#browser-loading');

        let url = urlInput.value.trim();
        if (!url) return;

        // Add protocol if missing
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
            url = 'https://' + url;
            urlInput.value = url;
        }

        // Show loading
        loading.classList.remove('hidden');

        // Navigate to URL
        iframe.src = url;

        // Hide loading after load
        iframe.onload = function() {
            loading.classList.add('hidden');
            urlInput.value = iframe.src;
        };

        iframe.onerror = function() {
            loading.classList.add('hidden');
            alert('æ— æ³•åŠ è½½è¯¥ç½‘é¡µ');
        };
    }

    function refreshBrowser(button) {
        const windowElement = button.closest('.fixed');
        const iframe = windowElement.querySelector('#browser-frame');
        const loading = windowElement.querySelector('#browser-loading');

        loading.classList.remove('hidden');
        iframe.src = iframe.src;

        iframe.onload = function() {
            loading.classList.add('hidden');
        };
    }

    function goHomeBrowser(button) {
        const windowElement = button.closest('.fixed');
        const urlInput = windowElement.querySelector('#browser-url');
        const iframe = windowElement.querySelector('#browser-frame');
        const loading = windowElement.querySelector('#browser-loading');

        urlInput.value = 'https://www.baidu.com';
        loading.classList.remove('hidden');
        iframe.src = 'https://www.baidu.com';

        iframe.onload = function() {
            loading.classList.add('hidden');
        };
    }

    // Handle window before unload to save state
    window.addEventListener('beforeunload', saveSystemState);
</script>
</body>
</html>