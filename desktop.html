<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CircleOS - Ê°åÈù¢</title>
    <link rel="stylesheet" href="assets/styles/global.css">
    <style>
        .desktop {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(45, 0, 89, 0.95);
            border-top: 2px solid var(--primary-pink);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
        }

        .start-button {
            background: linear-gradient(45deg, var(--primary-pink), var(--primary-purple));
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            margin-right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(255, 105, 180, 0.5);
        }

        .taskbar-icons {
            display: flex;
            gap: 10px;
            margin-right: auto;
        }

        .taskbar-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .taskbar-icon:hover {
            background: rgba(255, 105, 180, 0.2);
            border-color: var(--primary-pink);
        }

        .taskbar-icon.active {
            background: rgba(255, 105, 180, 0.3);
            border-color: var(--primary-pink);
        }

        .tray {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .tray-icon {
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tray-icon:hover {
            background: rgba(255, 105, 180, 0.2);
        }

        .taskbar-clock {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            color: var(--text-primary);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .taskbar-clock:hover {
            background: rgba(255, 105, 180, 0.2);
        }

        .start-menu {
            position: fixed;
            bottom: 60px;
            left: 20px;
            width: 300px;
            background: rgba(45, 0, 89, 0.95);
            border: 2px solid var(--primary-pink);
            border-radius: 20px 20px 0 0;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-glow);
            display: none;
            z-index: 999;
        }

        .start-menu.show {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .start-menu-header {
            background: linear-gradient(45deg, var(--primary-pink), var(--primary-purple));
            padding: 15px 20px;
            border-radius: 18px 18px 0 0;
            font-weight: bold;
            font-size: 18px;
        }

        .start-menu-items {
            padding: 10px 0;
        }

        .start-menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-primary);
            text-decoration: none;
        }

        .start-menu-item:hover {
            background: rgba(255, 105, 180, 0.2);
        }

        .start-menu-item i {
            width: 24px;
            text-align: center;
            font-size: 20px;
        }

        .desktop-icons {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
        }

        .desktop-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 15px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 15px;
            width: 100px;
        }

        .desktop-icon:hover {
            background: rgba(255, 105, 180, 0.2);
            transform: translateY(-2px);
        }

        .desktop-icon-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(45deg, var(--primary-pink), var(--primary-purple));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: var(--shadow-glow);
        }

        .desktop-icon-label {
            font-size: 12px;
            color: var(--text-primary);
            text-align: center;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
<!-- Á¥´Ëâ≤Âä®ÊÄÅÁ∫øÊù° -->
<div class="purple-line"></div>
<div class="purple-line"></div>
<div class="purple-line"></div>

<div class="desktop" id="desktop">
    <!-- Ê°åÈù¢ÂõæÊ†á -->
    <div class="desktop-icons">
        <div class="desktop-icon" onclick="openSettings()">
            <div class="desktop-icon-icon">‚öôÔ∏è</div>
            <div class="desktop-icon-label">ËÆæÁΩÆ</div>
        </div>
    </div>

    <!-- ‰ªªÂä°Ê†è -->
    <div class="taskbar">
        <button class="start-button" onclick="toggleStartMenu()">
            <span>‚ò∞</span>
            <span>ÂºÄÂßã</span>
        </button>

        <div class="taskbar-icons" id="taskbarIcons">
            <!-- ‰ªªÂä°Ê†èÂõæÊ†áÂ∞ÜÂä®ÊÄÅÊ∑ªÂä† -->
        </div>

        <div class="tray">
            <div class="tray-icon" title="ËøîÂõû‰∏ªÁîªÈù¢" onclick="goToMainScreen()">üè†</div>
            <div class="taskbar-clock" id="taskbarClock">00:00</div>
        </div>
    </div>

    <!-- ÂºÄÂßãËèúÂçï -->
    <div class="start-menu" id="startMenu">
        <div class="start-menu-header">
            CircleOS ÂºÄÂßãËèúÂçï
        </div>
        <div class="start-menu-items">
            <a href="#" class="start-menu-item" onclick="openSettings(); return false;">
                <i>‚öôÔ∏è</i>
                <span>ËÆæÁΩÆ</span>
            </a>
            <a href="#" class="start-menu-item" onclick="checkForUpdates(); return false;">
                <i>üîÑ</i>
                <span>Êõ¥Êñ∞</span>
            </a>
            <a href="#" class="start-menu-item" onclick="lockSystem(); return false;">
                <i>üîí</i>
                <span>ÈîÅÂÆöÁ≥ªÁªü</span>
            </a>
            <a href="#" class="start-menu-item" onclick="restartSystem(); return false;">
                <i>üîÑ</i>
                <span>ÈáçÂêØ</span>
            </a>
            <a href="#" class="start-menu-item" onclick="shutdownSystem(); return false;">
                <i>‚èªÔ∏è</i>
                <span>ÂÖ≥Êú∫</span>
            </a>
        </div>
    </div>
</div>

<script src="assets/scripts/utils.js"></script>
<script>
    let startMenuOpen = false;

    function toggleStartMenu() {
        const startMenu = document.getElementById('startMenu');
        startMenuOpen = !startMenuOpen;

        if (startMenuOpen) {
            startMenu.classList.add('show');
        } else {
            startMenu.classList.remove('show');
        }
    }

    function updateClock() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('zh-CN', {
            hour: '2-digit',
            minute: '2-digit'
        });
        document.getElementById('taskbarClock').textContent = timeString;
    }

    function openSettings() {
        // Ê£ÄÊü•ËÆæÁΩÆÁ™óÂè£ÊòØÂê¶Â∑≤ÊâìÂºÄ
        const existingSettingsWindow = windowManager.windows.find(w => w.title === 'Á≥ªÁªüËÆæÁΩÆ');
        if (existingSettingsWindow) {
            windowManager.setActiveWindow(existingSettingsWindow.id);
            return;
        }

        // Âä†ËΩΩËÆæÁΩÆÂ∫îÁî®ÂÜÖÂÆπ
        fetch('apps/app-settings.html')
            .then(response => response.text())
            .then(html => {
                const settingsWindowId = windowManager.createWindow({
                    title: 'Á≥ªÁªüËÆæÁΩÆ',
                    content: html,
                    width: 600,
                    height: 500
                });

                // Ê∑ªÂä†Âà∞‰ªªÂä°Ê†è
                addTaskbarIcon('‚öôÔ∏è', 'Á≥ªÁªüËÆæÁΩÆ', settingsWindowId);

                // ÊâßË°åËÆæÁΩÆÈ°µÈù¢ÁöÑËÑöÊú¨
                const script = document.createElement('script');
                script.textContent = `
                        // ËÆæÁΩÆÈ°µÈù¢ÁöÑËÑöÊú¨
                        document.getElementById('saveSettings').onclick = function() {
                            const username = document.getElementById('username').value;
                            const theme = document.getElementById('theme').value;
                            
                            if (username) {
                                showNotification('ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ', 'success');
                                setTimeout(() => {
                                    windowManager.closeWindow(${settingsWindowId});
                                    removeTaskbarIcon(${settingsWindowId});
                                }, 1000);
                            } else {
                                showNotification('ËØ∑ËæìÂÖ•Áî®Êà∑Âêç', 'error');
                            }
                        };
                        
                        document.getElementById('cancelSettings').onclick = function() {
                            windowManager.closeWindow(${settingsWindowId});
                            removeTaskbarIcon(${settingsWindowId});
                        };
                    `;

                const windowContent = windowManager.windows.find(w => w.id === settingsWindowId).element.querySelector('.window-content');
                windowContent.appendChild(script);
            })
            .catch(error => {
                console.error('Failed to load settings:', error);
                showNotification('Êó†Ê≥ïÂä†ËΩΩËÆæÁΩÆÈ°µÈù¢', 'error');
            });
    }

    function addTaskbarIcon(icon, title, windowId) {
        const taskbarIcons = document.getElementById('taskbarIcons');
        const iconElement = document.createElement('div');
        iconElement.className = 'taskbar-icon active';
        iconElement.title = title;
        iconElement.innerHTML = icon;
        iconElement.dataset.windowId = windowId;

        iconElement.onclick = () => {
            const windowObj = windowManager.windows.find(w => w.id === windowId);
            if (windowObj) {
                windowManager.setActiveWindow(windowId);
            }
        };

        taskbarIcons.appendChild(iconElement);
    }

    function removeTaskbarIcon(windowId) {
        const taskbarIcons = document.getElementById('taskbarIcons');
        const iconElement = taskbarIcons.querySelector(`[data-window-id="${windowId}"]`);
        if (iconElement) {
            iconElement.remove();
        }
    }

    function lockSystem() {
        const confirmLock = confirm('Á°ÆÂÆöË¶ÅÈîÅÂÆöÁ≥ªÁªüÂêóÔºü');
        if (confirmLock) {
            showNotification('Á≥ªÁªüÂ∑≤ÈîÅÂÆö', 'info');
            setTimeout(() => {
                window.location.href = 'lock-screen.html';
            }, 1000);
        }
    }

    function checkForUpdates() {
        // Ê£ÄÊü•Êõ¥Êñ∞Á™óÂè£ÊòØÂê¶Â∑≤ÊâìÂºÄ
        const existingUpdateWindow = windowManager.windows.find(w => w.title === 'Á≥ªÁªüÊõ¥Êñ∞');
        if (existingUpdateWindow) {
            windowManager.setActiveWindow(existingUpdateWindow.id);
            return;
        }

        // Âä†ËΩΩÊõ¥Êñ∞Ê£ÄÊü•Âô®Â∫îÁî®ÂÜÖÂÆπ
        fetch('apps/app-update-checker.html')
            .then(response => response.text())
            .then(html => {
                const updateWindowId = windowManager.createWindow({
                    title: 'Á≥ªÁªüÊõ¥Êñ∞',
                    content: html,
                    width: 500,
                    height: 450
                });

                // Ê∑ªÂä†Âà∞‰ªªÂä°Ê†è
                addTaskbarIcon('üîÑ', 'Á≥ªÁªüÊõ¥Êñ∞', updateWindowId);
            })
            .catch(error => {
                console.error('Failed to load update checker:', error);
                showNotification('Êó†Ê≥ïÂä†ËΩΩÊõ¥Êñ∞Ê£ÄÊü•Âô®', 'error');
            });
    }

    function restartSystem() {
        const confirmRestart = confirm('Á°ÆÂÆöË¶ÅÈáçÂêØÁ≥ªÁªüÂêóÔºü');
        if (confirmRestart) {
            showNotification('Ê≠£Âú®ÈáçÂêØÁ≥ªÁªü...', 'info');
            setTimeout(() => {
                window.location.href = 'boot.html';
            }, 1000);
        }
    }

    function shutdownSystem() {
        const confirmShutdown = confirm('Á°ÆÂÆöË¶ÅÂÖ≥Êú∫ÂêóÔºü');
        if (confirmShutdown) {
            showNotification('Ê≠£Âú®ÂÖ≥Êú∫...', 'info');
            setTimeout(() => {
                // ÂÖ≥Èó≠ÂΩìÂâçÊ†áÁ≠æÈ°µ
                window.close();

                // Â¶ÇÊûúÊó†Ê≥ïÂÖ≥Èó≠Ôºà‰∏çÊòØÁî±ËÑöÊú¨ÊâìÂºÄÁöÑÊ†áÁ≠æÈ°µÔºâÔºåÊòæÁ§∫ÊèêÁ§∫
                setTimeout(() => {
                    alert('ËØ∑ÊâãÂä®ÂÖ≥Èó≠ÊµèËßàÂô®Á™óÂè£‰ª•ÂÆåÊàêÂÖ≥Êú∫');
                }, 100);
            }, 1000);
        }
    }

    // ÁÇπÂáªÊ°åÈù¢Á©∫ÁôΩÂ§ÑÂÖ≥Èó≠ÂºÄÂßãËèúÂçï
    document.getElementById('desktop').addEventListener('click', (e) => {
        if (startMenuOpen && !e.target.closest('.start-menu') && !e.target.closest('.start-button')) {
            toggleStartMenu();
        }
    });

    function goToMainScreen() {
        window.location.href = 'click-to-enter.html';
    }

    // Á≥ªÁªüÂàùÂßãÂåñ
    document.addEventListener('DOMContentLoaded', () => {
        initializeSystem();
        updateClock();

        // ÊØèÁßíÊõ¥Êñ∞Êó∂Èíü
        setInterval(updateClock, 1000);

        showNotification('Ê¨¢Ëøé‰ΩøÁî® CircleOSÔºÅ', 'success');

        // ÁõëÂê¨Á™óÂè£ÂÖ≥Èó≠‰∫ã‰ª∂ÔºåÊõ¥Êñ∞‰ªªÂä°Ê†è
        const originalCloseWindow = windowManager.closeWindow.bind(windowManager);
        windowManager.closeWindow = (id) => {
            removeTaskbarIcon(id);
            originalCloseWindow(id);
        };
    });
</script>
</body>
</html>